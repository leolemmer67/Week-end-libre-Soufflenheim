<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration Plan</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1e293b; color: white; padding: 20px; margin: 0; }
        
        /* Conteneur de la carte */
        #map-container {
            position: relative; 
            width: 1000px; /* Largeur fixe pour le positionnement pr√©cis */
            height: 600px; 
            margin: 20px auto;
            background-image: url('https://images.unsplash.com/photo-1547623641-82fbb83b169e?q=80&w=1000&auto=format&fit=crop'); /* Remplace par ton image d'√©tang */
            background-size: cover; 
            border: 4px solid white; 
            border-radius: 8px;
            overflow: hidden;
        }

        .poste-marker {
            position: absolute; width: 30px; height: 30px;
            background: #ef4444; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid white; cursor: grab;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); user-select: none;
            z-index: 10;
        }
        .poste-marker:active { cursor: grabbing; background: #b91c1c; }

        .btn-save { background: #10b981; color: white; padding: 15px 30px; font-size: 1.2em; border: none; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        .btn-save:hover { background: #059669; }
        a { color: #cbd5e1; text-decoration: none; margin-left: 15px; }
    </style>
</head>
<body>

    <h2>üìç Glisse les postes √† leur place</h2>
    <button class="btn-save" id="btnSave">üíæ SAUVEGARDER POSITIONS</button>
    <a href="admin.html">‚Üê Retour Admin</a>

    <div id="map-container">
        <!-- Les bulles seront g√©n√©r√©es ici -->
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // TES CL√âS EXACTES
        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const container = document.getElementById('map-container');

        // Initialisation
        (async function init() {
            // 1. R√©cup√©rer les positions existantes
            const { data, error } = await supabase.from('postes_config').select('*');
            if(error) console.error("Erreur chargement:", error);

            // 2. Cr√©er les 24 bulles
            for(let i=1; i<=24; i++) {
                const el = document.createElement('div');
                el.className = 'poste-marker';
                el.id = 'p-'+i;
                el.innerText = i;
                
                // Position par d√©faut (align√©es en haut si pas de config)
                let top = '10%';
                let left = (i * 3.5) + '%';

                // Appliquer la position sauvegard√©e si elle existe
                if(data) {
                    const saved = data.find(p => p.poste_id === i);
                    if(saved) {
                        left = saved.pos_x + '%';
                        top = saved.pos_y + '%';
                    }
                }
                
                el.style.left = left;
                el.style.top = top;
                
                makeDraggable(el);
                container.appendChild(el);
            }
        })();

        // Sauvegarde
        document.getElementById('btnSave').addEventListener('click', async () => {
            const updates = [];
            const rect = container.getBoundingClientRect();

            for(let i=1; i<=24; i++) {
                const el = document.getElementById('p-'+i);
                
                // Calcul en pourcentage (pour que √ßa reste bon sur mobile/tablette)
                const xPct = (el.offsetLeft / rect.width) * 100;
                const yPct = (el.offsetTop / rect.height) * 100;

                updates.push({ poste_id: i, pos_x: xPct, pos_y: yPct });
            }

            const { error } = await supabase.from('postes_config').upsert(updates);
            if(error) alert("Erreur: " + error.message);
            else alert("‚úÖ Positions mises √† jour !");
        });

        // Logique de Drag & Drop (Souris)
        function makeDraggable(elmnt) {
            let pos1=0, pos2=0, pos3=0, pos4=0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                // Calcul nouvelle position
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Appliquer (sans sortir du cadre id√©alement)
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>
</body>
</html>
