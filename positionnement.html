<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üõë C'EST CETTE LIGNE QUI CORRIGE L'ERREUR "FAILED TO FETCH" -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <title>Positionnement des Postes (Admin)</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; margin: 0; padding: 20px; }
        
        h1 { margin-bottom: 10px; }
        p { color: #aaa; margin-bottom: 20px; }

        /* Conteneur de l'image */
        #map-container {
            position: relative;
            display: inline-block;
            border: 2px solid #555;
            cursor: crosshair;
        }

        #pond-image {
            display: block;
            max-width: 1000px;
            width: 100%;
            height: auto;
            pointer-events: none; /* Emp√™che de glisser l'image elle-m√™me */
        }

        /* Les bulles des postes */
        .draggable {
            position: absolute;
            width: 30px; height: 30px;
            background: #22c55e;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: grab;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .draggable:active { cursor: grabbing; background: #16a34a; transform: scale(1.1); }

        .btn-save {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background: #0ea5e9;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .btn-save:hover { background: #0284c7; }
        
        .back-link { display: block; margin-top: 20px; color: #888; text-decoration: none; }
    </style>
</head>
<body>

    <h1>üìç Mode √âdition : Place tes postes</h1>
    <p>Glisse les num√©ros au bon endroit sur la carte, puis clique sur "SAUVEGARDER".</p>

    <div id="map-container">
        <!-- L'image de l'√©tang -->
        <img src="pond.jpg" id="pond-image" alt="Plan √âtang">
        
        <!-- Les Postes (positions par d√©faut 0,0 au d√©but) -->
        <div class="draggable" id="p1" data-id="1" style="top:10%; left:10%">1</div>
        <div class="draggable" id="p2" data-id="2" style="top:10%; left:15%">2</div>
        <div class="draggable" id="p3" data-id="3" style="top:10%; left:20%">3</div>
        <div class="draggable" id="p4" data-id="4" style="top:10%; left:25%">4</div>
        <div class="draggable" id="p5" data-id="5" style="top:10%; left:30%">5</div>
        <div class="draggable" id="p6" data-id="6" style="top:10%; left:35%">6</div>
        <div class="draggable" id="p7" data-id="7" style="top:10%; left:40%">7</div>
        <div class="draggable" id="p8" data-id="8" style="top:10%; left:45%">8</div>
        <div class="draggable" id="p9" data-id="9" style="top:10%; left:50%">9</div>
        <div class="draggable" id="p10" data-id="10" style="top:10%; left:55%">10</div>
    </div>

    <br>
    <button class="btn-save" onclick="sauvegarder()">üíæ SAUVEGARDER LES POSITIONS</button>
    
    <a href="admin.html" class="back-link">‚Üê Retour Admin</a>

    <!-- SCRIPT -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // Tes identifiants Supabase
        const SUPABASE_URL = 'https://drhsdlrxhkbamwcskblr.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1ODcyMjYsImV4cCI6MjA1NDE2MzIyNn0.S5v0-u1VvLGe_3iS-bTbQrnT9p0k9ZkwG-iS_Wiw7pQ'
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        // Gestion du Drag & Drop
        let activeItem = null;
        let activeX = 0;
        let activeY = 0;
        const container = document.getElementById('map-container');

        document.querySelectorAll('.draggable').forEach(item => {
            item.addEventListener('mousedown', dragStart);
            item.addEventListener('touchstart', dragStart, {passive: false});
        });

        function dragStart(e) {
            activeItem = e.target;
            
            // Calculer l'offset pour attraper l'√©l√©ment par le milieu/endroit cliqu√©
            const rect = activeItem.getBoundingClientRect();
            
            if (e.type === 'touchstart') {
                activeX = e.touches[0].clientX - rect.left;
                activeY = e.touches[0].clientY - rect.top;
            } else {
                activeX = e.clientX - rect.left;
                activeY = e.clientY - rect.top;
            }

            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', drag, {passive: false});
        }

        function drag(e) {
            if (!activeItem) return;
            e.preventDefault();

            const containerRect = container.getBoundingClientRect();
            let clientX, clientY;

            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // Calculer la nouvelle position relative au conteneur
            let x = clientX - containerRect.left - activeX;
            let y = clientY - containerRect.top - activeY;

            // Convertir en pourcentage pour que √ßa reste responsive
            let xPercent = (x / containerRect.width) * 100;
            let yPercent = (y / containerRect.height) * 100;

            activeItem.style.left = xPercent + '%';
            activeItem.style.top = yPercent + '%';
        }

        function dragEnd() {
            activeItem = null;
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchend', dragEnd);
            document.removeEventListener('touchmove', drag);
        }

        // Fonction de sauvegarde globale
        window.sauvegarder = async function() {
            const updates = [];
            
            document.querySelectorAll('.draggable').forEach(item => {
                const id = parseInt(item.getAttribute('data-id'));
                const top = item.style.top;
                const left = item.style.left;

                updates.push({
                    poste_numero: id,
                    top_pos: top,
                    left_pos: left
                });
            });

            console.log("Envoi vers Supabase...", updates);

            // Utilisation de upsert pour mettre √† jour ou cr√©er
            const { data, error } = await supabase
                .from('post_positions')
                .upsert(updates, { onConflict: 'poste_numero' });

            if (error) {
                console.error("Erreur Supabase:", error);
                alert("‚ùå Erreur sauvegarde: " + error.message);
            } else {
                alert("‚úÖ Positions sauvegard√©es avec succ√®s !");
            }
        }

        // Au chargement, r√©cup√©rer les positions existantes pour ne pas tout refaire
        async function loadExistingPositions() {
            const { data } = await supabase.from('post_positions').select('*');
            if(data) {
                data.forEach(pos => {
                    const el = document.getElementById('p' + pos.poste_numero);
                    if(el) {
                        el.style.top = pos.top_pos;
                        el.style.left = pos.left_pos;
                    }
                });
            }
        }

        loadExistingPositions();

    </script>
</body>
</html>
