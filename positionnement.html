<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Plan</title>
    <!-- On autorise Supabase et les images -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; text-align: center; background: #1e293b; color: white; padding: 20px; }
        #map-container {
            position: relative; width: 1000px; height: 600px; margin: 20px auto;
            background-image: url('https://images.unsplash.com/photo-1547623641-82fbb83b169e?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; border: 4px solid white; border-radius: 8px;
        }
        .poste-marker {
            position: absolute; width: 40px; height: 40px;
            background: #ef4444; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid white; cursor: grab;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); user-select: none;
        }
        .btn-save { background: #10b981; color: white; padding: 15px 30px; font-size: 1.2em; border: none; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <h2>üìç Configurer les Postes</h2>
    <p>Glisse les bulles et clique sur Sauvegarder.</p>
    
    <button class="btn-save" onclick="savePositions()">üíæ SAUVEGARDER POSITIONS</button>
    <a href="admin.html" style="color:white; margin-left:20px;">Retour Admin</a>

    <div id="map-container"></div>

    <script>
        // ‚ö†Ô∏è REMPLACE CECI PAR TES INFOS SUPABASE ACTUELLES (V√©rifie sur le site Supabase)
        // Si ton projet √©tait en pause, l'URL a peut-√™tre chang√© ou doit √™tre r√©activ√©e.
        const supabaseUrl = 'https://drhsdlzhxkbamwcskblr.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';
        
        const client = supabase.createClient(supabaseUrl, supabaseKey);
        const container = document.getElementById('map-container');

        // 1. Charger les postes au d√©marrage
        async function init() {
            // On v√©rifie d'abord si la table existe et on r√©cup√®re les infos
            const { data, error } = await client.from('postes_config').select('*');
            
            if (error) {
                console.error("Erreur Supabase:", error);
                alert("Erreur de connexion ! V√©rifie la console (F12) et tes cl√©s Supabase.");
            }

            for(let i=1; i<=24; i++) {
                const el = document.createElement('div');
                el.className = 'poste-marker';
                el.id = 'p-'+i;
                el.innerText = i;
                
                // Position par d√©faut
                let top = '50px';
                let left = (i * 35) + 'px';

                // Si on a une position sauvegard√©e, on l'utilise
                if(data) {
                    const saved = data.find(p => p.poste_id === i);
                    if(saved) {
                        left = saved.pos_x + '%';
                        top = saved.pos_y + '%';
                    }
                }
                
                el.style.left = left;
                el.style.top = top;
                
                makeDraggable(el);
                container.appendChild(el);
            }
        }

        // Fonction pour rendre les bulles d√©pla√ßables
        function makeDraggable(elmnt) {
            let pos1=0, pos2=0, pos3=0, pos4=0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // 2. Sauvegarder dans la base de donn√©es
        async function savePositions() {
            const updates = [];
            const rect = container.getBoundingClientRect();

            for(let i=1; i<=24; i++) {
                const el = document.getElementById('p-'+i);
                // On calcule en pourcentage pour que √ßa marche sur tous les √©crans
                const xPct = (el.offsetLeft / rect.width) * 100;
                const yPct = (el.offsetTop / rect.height) * 100;

                updates.push({ poste_id: i, pos_x: xPct, pos_y: yPct });
            }

            const { error } = await client.from('postes_config').upsert(updates);
            
            if(error) alert("Erreur sauvegarde : " + error.message);
            else alert("‚úÖ Positions sauvegard√©es !");
        }

        // Lancer le script
        init();
    </script>
</body>
</html>
