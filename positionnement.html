<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Positionnement des Postes</title>
    
    <!-- 1. On charge Supabase de fa√ßon classique -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; padding: 20px; }
        #map-container { position: relative; display: inline-block; border: 2px solid #555; }
        #pond-image { display: block; max-width: 1000px; width: 100%; height: auto; pointer-events: none; }
        .draggable {
            position: absolute; width: 30px; height: 30px; background: #22c55e;
            color: white; border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: grab; font-weight: bold; user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .btn-save { margin-top: 20px; padding: 15px 30px; background: #0ea5e9; color: white; border: none; cursor: pointer; font-size: 18px; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>üìç Positionnement des Postes</h1>
    <div id="map-container">
        <img src="pond.jpg" id="pond-image" alt="Plan √âtang">
        
        <!-- Postes -->
        <div class="draggable" id="p1" data-id="1" style="top:10%; left:10%">1</div>
        <div class="draggable" id="p2" data-id="2" style="top:10%; left:15%">2</div>
        <div class="draggable" id="p3" data-id="3" style="top:10%; left:20%">3</div>
        <div class="draggable" id="p4" data-id="4" style="top:10%; left:25%">4</div>
        <div class="draggable" id="p5" data-id="5" style="top:10%; left:30%">5</div>
        <div class="draggable" id="p6" data-id="6" style="top:10%; left:35%">6</div>
        <div class="draggable" id="p7" data-id="7" style="top:10%; left:40%">7</div>
        <div class="draggable" id="p8" data-id="8" style="top:10%; left:45%">8</div>
        <div class="draggable" id="p9" data-id="9" style="top:10%; left:50%">9</div>
        <div class="draggable" id="p10" data-id="10" style="top:10%; left:55%">10</div>
    </div>

    <br>
    <button class="btn-save" onclick="sauvegarder()">üíæ SAUVEGARDER</button>
    <br><br>
    <a href="admin.html" style="color: #aaa;">Retour Admin</a>

    <script>
        // 2. Initialisation Supabase (Version classique)
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1ODcyMjYsImV4cCI6MjA1NDE2MzIyNn0.S5v0-u1VvLGe_3iS-bTbQrnT9p0k9ZkwG-iS_Wiw7pQ';
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        // --- Logique Drag & Drop (Version Mobile & PC) ---
        let activeItem = null;
        let activeX = 0, activeY = 0;
        const container = document.getElementById('map-container');

        document.querySelectorAll('.draggable').forEach(item => {
            item.addEventListener('mousedown', dragStart);
            item.addEventListener('touchstart', dragStart, {passive: false});
        });

        function dragStart(e) {
            activeItem = e.target;
            const rect = activeItem.getBoundingClientRect();
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            
            activeX = clientX - rect.left;
            activeY = clientY - rect.top;

            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', drag, {passive: false});
        }

        function drag(e) {
            if (!activeItem) return;
            e.preventDefault();
            const containerRect = container.getBoundingClientRect();
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

            let x = clientX - containerRect.left - activeX;
            let y = clientY - containerRect.top - activeY;

            let xPercent = (x / containerRect.width) * 100;
            let yPercent = (y / containerRect.height) * 100;

            activeItem.style.left = xPercent + '%';
            activeItem.style.top = yPercent + '%';
        }

        function dragEnd() {
            activeItem = null;
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchend', dragEnd);
            document.removeEventListener('touchmove', drag);
        }

        // --- Sauvegarde ---
        async function sauvegarder() {
            const updates = [];
            document.querySelectorAll('.draggable').forEach(item => {
                updates.push({
                    poste_numero: parseInt(item.getAttribute('data-id')),
                    top_pos: item.style.top,
                    left_pos: item.style.left
                });
            });

            console.log("Sauvegarde en cours...");
            
            // On utilise .upsert
            const { error } = await client
                .from('post_positions')
                .upsert(updates, { onConflict: 'poste_numero' });

            if (error) {
                alert("Erreur: " + error.message);
                console.error(error);
            } else {
                alert("‚úÖ Positions sauvegard√©es !");
            }
        }

        // --- Chargement ---
        async function load() {
            const { data, error } = await client.from('post_positions').select('*');
            if (data) {
                data.forEach(pos => {
                    const el = document.getElementById('p' + pos.poste_numero);
                    if (el) {
                        el.style.top = pos.top_pos;
                        el.style.left = pos.left_pos;
                    }
                });
            }
        }
        load();
    </script>
</body>
</html>
