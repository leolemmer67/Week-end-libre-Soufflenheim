<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Positionnement des Postes</title>
    
    <!-- Importation simple de Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; padding: 20px; margin: 0; }
        
        /* Conteneur Map */
        #map-container {
            position: relative;
            display: inline-block;
            border: 2px solid #555;
            margin-top: 20px;
        }

        #pond-image {
            display: block;
            max-width: 100%;
            height: auto;
            /* Emp√™che de s√©lectionner l'image sur mobile */
            user-select: none;
            pointer-events: none; 
        }

        /* Les Postes (Bulles) */
        .draggable {
            position: absolute;
            width: 30px; height: 30px;
            background: #22c55e;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            cursor: grab;
            user-select: none;
            touch-action: none; /* Crucial pour le drag sur mobile */
            z-index: 100;
        }

        .draggable:active { transform: scale(1.2); cursor: grabbing; background: #facc15; }

        /* Boutons */
        .btn-save {
            margin-top: 20px;
            padding: 15px 40px;
            background: #0ea5e9;
            color: white;
            border: none;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-save:hover { background: #0284c7; }

        a { color: #aaa; text-decoration: none; display: inline-block; margin-top: 20px;}
    </style>
</head>
<body>

    <h1>üìç Configurer les Postes</h1>
    <p>Glisse les bulles sur l'image et clique sur Sauvegarder.</p>

    <div id="map-container">
        <!-- Mets ici le nom exact de ton image (pond.jpg, etang.png...) -->
        <img src="pond.jpg" id="pond-image" alt="Plan √âtang">
        
        <!-- Les 10 postes -->
        <div class="draggable" id="p1" data-id="1" style="top:10%; left:10%">1</div>
        <div class="draggable" id="p2" data-id="2" style="top:10%; left:18%">2</div>
        <div class="draggable" id="p3" data-id="3" style="top:10%; left:26%">3</div>
        <div class="draggable" id="p4" data-id="4" style="top:10%; left:34%">4</div>
        <div class="draggable" id="p5" data-id="5" style="top:10%; left:42%">5</div>
        <div class="draggable" id="p6" data-id="6" style="top:10%; left:50%">6</div>
        <div class="draggable" id="p7" data-id="7" style="top:10%; left:58%">7</div>
        <div class="draggable" id="p8" data-id="8" style="top:10%; left:66%">8</div>
        <div class="draggable" id="p9" data-id="9" style="top:10%; left:74%">9</div>
        <div class="draggable" id="p10" data-id="10" style="top:10%; left:82%">10</div>
    </div>

    <br>
    <button class="btn-save" onclick="sauvegarder()">üíæ SAUVEGARDER POSITIONS</button>
    <br>
    <a href="admin.html">‚Üê Retour Admin</a>

    <script>
        // CONFIGURATION SUPABASE
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1ODcyMjYsImV4cCI6MjA1NDE2MzIyNn0.S5v0-u1VvLGe_3iS-bTbQrnT9p0k9ZkwG-iS_Wiw7pQ';
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        // --- GESTION DU DRAG & DROP (SOURIS + DOIGT) ---
        let activeItem = null;
        let startX = 0, startY = 0;
        let initialLeft = 0, initialTop = 0;
        const container = document.getElementById('map-container');

        document.querySelectorAll('.draggable').forEach(item => {
            // Souris
            item.addEventListener('mousedown', dragStart);
            // Tactile
            item.addEventListener('touchstart', dragStart, { passive: false });
        });

        function dragStart(e) {
            e.preventDefault();
            activeItem = e.target;
            
            // Position initiale de la souris/doigt
            if(e.type === 'touchstart') {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            } else {
                startX = e.clientX;
                startY = e.clientY;
            }

            // Position actuelle de l'√©l√©ment (en pixels pour le calcul)
            initialLeft = activeItem.offsetLeft;
            initialTop = activeItem.offsetTop;

            // √âcouteurs globaux pour suivre le mouvement
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', dragMove, { passive: false });
        }

        function dragMove(e) {
            if (!activeItem) return;
            e.preventDefault(); // Emp√™che le scroll de la page sur mobile

            let currentX, currentY;

            if(e.type === 'touchmove') {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
            } else {
                currentX = e.clientX;
                currentY = e.clientY;
            }

            const dx = currentX - startX;
            const dy = currentY - startY;

            // Calcul en Pourcentage pour que √ßa reste responsive
            const containerRect = container.getBoundingClientRect();
            
            let newLeft = ((initialLeft + dx) / containerRect.width) * 100;
            let newTop = ((initialTop + dy) / containerRect.height) * 100;

            activeItem.style.left = newLeft + '%';
            activeItem.style.top = newTop + '%';
        }

        function dragEnd() {
            activeItem = null;
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('touchend', dragEnd);
            document.removeEventListener('touchmove', dragMove);
        }

        // --- SAUVEGARDE VERS SUPABASE ---
        async function sauvegarder() {
            const updates = [];
            
            document.querySelectorAll('.draggable').forEach(item => {
                updates.push({
                    poste_numero: parseInt(item.getAttribute('data-id')),
                    top_pos: item.style.top,
                    left_pos: item.style.left
                });
            });

            console.log("Envoi...", updates);

            const { data, error } = await client
                .from('post_positions')
                .upsert(updates, { onConflict: 'poste_numero' });

            if (error) {
                console.error(error);
                alert("‚ùå Erreur : " + error.message);
            } else {
                alert("‚úÖ Positions sauvegard√©es avec succ√®s !");
            }
        }

        // --- CHARGEMENT ---
        async function chargerPositions() {
            const { data, error } = await client.from('post_positions').select('*');
            
            if (error) {
                console.error("Erreur chargement:", error);
                return;
            }

            if (data) {
                data.forEach(pos => {
                    const el = document.getElementById('p' + pos.poste_numero);
                    if (el) {
                        el.style.top = pos.top_pos;
                        el.style.left = pos.left_pos;
                    }
                });
            }
        }

        // Lancer le chargement au d√©marrage
        chargerPositions();

    </script>
</body>
</html>
