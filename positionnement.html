<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration du Plan</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1e293b; color: white; padding: 20px; }
        
        /* Logo */
        .logo { max-width: 150px; margin-bottom: 20px; }

        /* Conteneur de la carte */
        #map-container {
            position: relative; 
            display: inline-block; 
            border: 4px solid white; 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            margin-top: 20px;
        }

        /* Image de l'√©tang */
        #pond-image {
            display: block;
            max-width: 100%; 
            height: auto;
            user-select: none;
        }

        /* Les bulles */
        .poste-marker {
            position: absolute; width: 30px; height: 30px;
            background: #ef4444; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid white; cursor: grab;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); user-select: none;
            z-index: 10;
        }
        .poste-marker:active { cursor: grabbing; background: #b91c1c; }

        .btn-save { background: #10b981; color: white; padding: 15px 30px; font-size: 1.2em; border: none; cursor: pointer; border-radius: 5px; }
        .btn-save:hover { background: #059669; }
        a { color: #cbd5e1; text-decoration: none; margin-left: 15px; }
        
        .instructions { background: #334155; display: inline-block; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <!-- LOGO -->
    <img src="logo.png" alt="Section Carpe" class="logo"><br>

    <div class="instructions">
        <h2>üìç Mode Configuration</h2>
        <p>Glissez les 10 postes √† l'endroit exact sur l'√©tang.</p>
        <button class="btn-save" id="btnSave">üíæ SAUVEGARDER POSITIONS</button>
        <a href="admin.html">‚Üê Retour Admin</a>
    </div>
    <br>

    <div id="map-container">
        <!-- IMAGE DE L'ETANG -->
        <img src="pond.jpg" id="pond-image" alt="Plan de l'√©tang">
        <!-- Les bulles seront g√©n√©r√©es ici -->
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const container = document.getElementById('map-container');

        // Charger positions existantes
        (async function init() {
            const { data } = await supabase.from('postes_config').select('*');

            // Cr√©er 10 bulles
            for(let i=1; i<=10; i++) {
                const el = document.createElement('div');
                el.className = 'poste-marker';
                el.innerText = i;
                el.id = 'p-' + i;

                let top = '5%';
                let left = (i * 8) + '%'; 

                if(data) {
                    const saved = data.find(p => p.poste_id === i);
                    if(saved) {
                        left = saved.pos_x + '%';
                        top = saved.pos_y + '%';
                    }
                }
                
                el.style.left = left;
                el.style.top = top;
                
                makeDraggable(el);
                container.appendChild(el);
            }
        })();

        // Sauvegarde
        document.getElementById('btnSave').addEventListener('click', async () => {
            const updates = [];
            const rect = container.getBoundingClientRect(); 

            for(let i=1; i<=10; i++) {
                const el = document.getElementById('p-'+i);
                
                const xPct = (el.offsetLeft / rect.width) * 100;
                const yPct = (el.offsetTop / rect.height) * 100;

                updates.push({ poste_id: i, pos_x: xPct, pos_y: yPct });
            }

            const { error } = await supabase.from('postes_config').upsert(updates);
            if(error) alert("Erreur: " + error.message);
            else alert("‚úÖ Positions mises √† jour !");
        });

        // Drag & Drop
        function makeDraggable(elmnt) {
            let pos1=0, pos2=0, pos3=0, pos4=0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>
</body>
</html>
