<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 1. CORRECTION S√âCURIT√â : On autorise PayPal et Supabase explicitement -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdn.jsdelivr.net https://*.supabase.co https://*.paypal.com https://*.paypalobjects.com;">

    <title>R√©servation √âtang</title>
    
    <!-- SDK PayPal (Mode Test 'sb') -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0fdf4; margin: 0; padding: 20px; text-align: center; }

        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Logo */
        .logo { max-width: 120px; display: block; margin: 0 auto 10px auto; }
        h1 { color: #166534; margin-top: 0; }

        /* Bloc Tarif */
        .price-info {
            background-color: #dcfce7;
            color: #14532d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #86efac;
        }
        .price-tag { font-size: 1.4em; font-weight: bold; display: block; margin-bottom: 5px; }

        /* Carte */
        #map-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px auto;
            border: 4px solid #166534;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        #pond-image {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .poste-marker {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            font-size: 14px;
        }
        .poste-marker:hover { transform: scale(1.2); }
        .libre { background-color: #22c55e; border: 2px solid white; }
        .occupe { background-color: #ef4444; cursor: not-allowed; opacity: 0.8; }
        .selectionne { background-color: #eab308; border: 2px solid #000; transform: scale(1.3); z-index: 10; }

        /* Formulaire */
        .hidden { display: none; }
        #form-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }
        input {
            display: block; width: 80%; margin: 10px auto; padding: 10px;
            border: 1px solid #ccc; border-radius: 5px; font-size: 1em;
            background-color: #e2e8f0;
        }
        
        /* Container PayPal */
        #paypal-button-container {
            margin-top: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Footer admin */
        .admin-link {
            display: block; margin-top: 30px; color: #94a3b8; text-decoration: none; font-size: 0.9em;
            border: 1px solid #e2e8f0; padding: 5px 10px; border-radius: 5px; width: fit-content; margin-left: auto; margin-right: auto;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Logo -->
        <img src="https://cdn-icons-png.flaticon.com/512/2016/2016065.png" alt="Logo" class="logo">
        
        <h1>R√©servation √âtang</h1>

        <!-- Bloc Prix -->
        <div class="price-info">
            <span class="price-tag">Tarif Unique : 60‚Ç¨ / 24h</span>
            <span class="price-details">Arriv√©e 10h - D√©part 10h le lendemain</span>
        </div>

        <p>Cliquez sur un poste vert pour r√©server.</p>

        <!-- Carte -->
        <div id="map-wrapper">
            <!-- Image de fond (remplace par ton image r√©elle) -->
            <img id="pond-image" src="https://www.google.com/maps/vt/data=LYu70aR6d6Z9...placeholder" alt="Plan √©tang"> 
            <!-- Les bulles seront ajout√©es ici par JS -->
        </div>

        <!-- Formulaire de r√©servation -->
        <div id="form-section" class="hidden">
            <h3>R√©servation du Poste N¬∞ <span id="displayPoste"></span></h3>
            <p style="font-size: 0.9em; color: #64748b;">
                Veuillez remplir vos coordonn√©es ci-dessous.<br>
                Le paiement s√©curis√© de <strong>60‚Ç¨</strong> validera la r√©servation.
            </p>
            
            <input type="text" id="nom" placeholder="Votre Nom et Pr√©nom">
            <input type="email" id="email" placeholder="Votre Email">
            <input type="tel" id="tel" placeholder="Votre T√©l√©phone">

            <!-- BOUTON PAYPAL -->
            <div id="paypal-button-container"></div>
        </div>

        <a href="login.html" class="admin-link">üîí Administration</a>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'TON_URL_SUPABASE_ICI'; // <-- REMETS TON URL
        const SUPABASE_KEY = 'TA_CLE_SUPABASE_ICI';   // <-- REMETS TA CL√â
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Coordonn√©es des postes (inchang√©)
        const postesCoords = [
            { poste_id: 1, pos_x: 20, pos_y: 30 },
            { poste_id: 2, pos_x: 40, pos_y: 25 },
            { poste_id: 3, pos_x: 60, pos_y: 25 },
            { poste_id: 4, pos_x: 80, pos_y: 40 },
            { poste_id: 5, pos_x: 75, pos_y: 60 },
            { poste_id: 6, pos_x: 50, pos_y: 75 },
            { poste_id: 7, pos_x: 30, pos_y: 70 },
            { poste_id: 8, pos_x: 15, pos_y: 55 }
        ];

        let currentSessionId = 1; 
        let selectedPoste = null;

        async function init() {
            // Charge l'image correcte (Google Maps Satellite ou ton image locale)
            document.getElementById('pond-image').src = "https://maps.googleapis.com/maps/api/staticmap?center=48.828,7.965&zoom=17&size=800x400&maptype=satellite&key=TON_API_KEY_SI_TU_EN_AS"; 
            // NOTE : Si tu n'as pas de cl√© API Google, remets ton lien d'image pr√©c√©dent ici !

            loadMapStatus();
        }

        async function loadMapStatus() {
            // 1. R√©cup√©rer les r√©servations pour cette session
            const { data: reservations, error } = await supabase
                .from('reservations')
                .select('poste_numero')
                .eq('session_id', currentSessionId);

            if (error) console.error("Erreur chargement:", error);

            const taken = reservations ? reservations.map(r => r.poste_numero) : [];
            renderMap(taken);
        }

        function renderMap(taken) {
            const wrapper = document.getElementById('map-wrapper');
            // Nettoyer les anciennes bulles (garder l'image)
            document.querySelectorAll('.poste-marker').forEach(el => el.remove());

            for (let i = 1; i <= 8; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'poste-marker';
                bubble.innerText = i;

                const config = postesCoords.find(c => c.poste_id === i);
                let left = '50%', top = '50%';
                if (config) {
                    left = config.pos_x + '%';
                    top = config.pos_y + '%';
                }
                bubble.style.left = left;
                bubble.style.top = top;

                if (taken.includes(i)) {
                    bubble.classList.add('occupe');
                    bubble.title = "D√©j√† r√©serv√©";
                } else {
                    bubble.classList.add('libre');
                    bubble.onclick = () => selectPoste(i, bubble);
                }
                wrapper.appendChild(bubble);
            }
        }

        function selectPoste(id, element) {
            // Gestion de la s√©lection visuelle
            document.querySelectorAll('.selectionne').forEach(el => el.classList.remove('selectionne'));
            element.classList.add('selectionne');
            selectedPoste = id;

            // Afficher le formulaire
            document.getElementById('displayPoste').innerText = id;
            document.getElementById('form-section').classList.remove('hidden');
            
            // Initialiser le bouton PayPal (si pas d√©j√† fait)
            document.getElementById('paypal-button-container').innerHTML = ""; // Reset bouton pour √©viter doublons
            renderPayPalButton();

            // Scroll doux
            document.getElementById('form-section').scrollIntoView({behavior: "smooth"});
        }

        function renderPayPalButton() {
            if (typeof paypal === 'undefined') {
                alert("Erreur: PayPal n'a pas charg√©. V√©rifiez votre connexion.");
                return;
            }

            paypal.Buttons({
                // V√©rifier les champs avant
                onClick: (data, actions) => {
                    const nom = document.getElementById('nom').value;
                    const email = document.getElementById('email').value;
                    const tel = document.getElementById('tel').value;
                    
                    if (!nom || !email || !tel) {
                        alert("Veuillez remplir TOUS les champs (Nom, Email, T√©l) avant de payer.");
                        return actions.reject();
                    }
                    return actions.resolve();
                },
                // Cr√©er la commande
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: `R√©servation Poste ${selectedPoste}`,
                            amount: { value: '60.00' }
                        }]
                    });
                },
                // Paiement valid√©
                onApprove: (data, actions) => {
                    return actions.order.capture().then(async (details) => {
                        console.log('Paiement OK:', details);
                        
                        const nom = document.getElementById('nom').value;
                        const email = document.getElementById('email').value;
                        const tel = document.getElementById('tel').value;

                        // Sauvegarde Supabase
                        const { error } = await supabase.from('reservations').insert({
                            session_id: currentSessionId,
                            poste_numero: selectedPoste,
                            nom_client: nom,
                            email_client: email,
                            telephone_client: tel
                        });

                        if(error) {
                            alert("Paiement re√ßu mais erreur technique de sauvegarde. Contactez l'admin.");
                            console.error(error);
                        } else {
                            alert("‚úÖ R√©servation confirm√©e et pay√©e !");
                            location.reload();
                        }
                    });
                },
                onError: (err) => {
                    console.error('Erreur PayPal', err);
                    alert("Le paiement n'a pas pu aboutir.");
                }
            }).render('#paypal-button-container');
        }

        // Lancement
        init();
    </script>
</body>
</html>
