<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üü¢ AUTORISER SUPABASE ET PAYPAL -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <title>R√©servation √âtang Soufflenheim</title>

    <!-- Script PayPal (Mode Sandbox pour test) -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f9ff; text-align: center; margin: 0; padding: 20px; }
        h1 { color: #0ea5e9; margin-bottom: 20px; }

        /* Conteneur principal */
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* S√©lecteur de session */
        .session-selector { margin-bottom: 20px; }
        select { padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }

        /* Carte de l'√©tang */
        .map-wrapper {
            position: relative;
            display: inline-block;
            max-width: 100%;
            border: 4px solid #0ea5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        #pond-image {
            display: block;
            width: 100%;
            height: auto;
        }

        /* Boutons des postes */
        .poste-btn {
            position: absolute;
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            font-weight: bold;
            font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            color: white;
        }
        .poste-btn:hover { transform: scale(1.2); z-index: 10; }
        
        /* Couleurs d'√©tat */
        .libre { background-color: #22c55e; } /* Vert */
        .occupe { background-color: #64748b; cursor: not-allowed; } /* Gris */

        /* L√©gende */
        .legende { margin-top: 15px; display: flex; justify-content: center; gap: 20px; font-size: 14px; }
        .dot { width: 15px; height: 15px; display: inline-block; border-radius: 50%; margin-right: 5px; vertical-align: middle; }

        /* Modal de r√©servation */
        #booking-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: left; position: relative;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 0.9em; color: #555; }

        /* Bouton Admin discret */
        .admin-link { margin-top: 40px; display: block; color: #cbd5e1; text-decoration: none; font-size: 0.8em; }
        .admin-link:hover { color: #94a3b8; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üé£ R√©servation Week-end Libre</h1>

        <!-- Choix de la session -->
        <div class="session-selector">
            <label for="session-select">üìÖ Choisir une date :</label>
            <select id="session-select">
                <option value="" disabled selected>Chargement des dates...</option>
            </select>
        </div>

        <!-- Carte Interactive -->
        <div class="map-wrapper" id="map-container">
            <!-- Image de fond -->
            <img src="pond.jpg" id="pond-image" alt="Plan de l'√©tang">
            <!-- Les boutons seront inject√©s ici par JS -->
        </div>

        <div class="legende">
            <span><span class="dot" style="background:#22c55e"></span>Libre</span>
            <span><span class="dot" style="background:#64748b"></span>R√©serv√©</span>
        </div>
    </div>

    <!-- Modal R√©servation -->
    <div id="booking-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fermerModal()">&times;</span>
            <h2 id="modal-title">R√©server Poste X</h2>
            
            <label>Nom complet</label>
            <input type="text" id="nom" placeholder="Votre Nom">
            
            <label>Email</label>
            <input type="email" id="email" placeholder="votre@email.com">
            
            <label>T√©l√©phone</label>
            <input type="tel" id="tel" placeholder="06...">

            <div id="paypal-button-container" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Lien Admin -->
    <a href="admin.html" class="admin-link">Acc√®s Administrateur</a>

    <!-- SCRIPT LOGIQUE -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // üü¢ TES CL√âS SUPABASE CORRECTES
        const SUPABASE_URL = 'https://drhsdlrxhkbamwcskblr.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1ODcyMjYsImV4cCI6MjA1NDE2MzIyNn0.S5v0-u1VvLGe_3iS-bTbQrnT9p0k9ZkwG-iS_Wiw7pQ'
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        let selectedPoste = null;
        let selectedSessionId = null;

        // 1. D√©marrage
        async function init() {
            await chargerSessions();
            
            // √âcouteur sur le changement de date
            document.getElementById('session-select').addEventListener('change', (e) => {
                selectedSessionId = e.target.value;
                chargerCarte();
            });
        }

        // 2. Charger les sessions dans la liste
        async function chargerSessions() {
            const select = document.getElementById('session-select');
            const { data, error } = await supabase
                .from('sessions')
                .select('*')
                .eq('active', true) // Seulement les sessions actives
                .order('date_debut', { ascending: true });

            select.innerHTML = ''; // Vider le chargement

            if (data && data.length > 0) {
                data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.nom} (${formatDate(s.date_debut)})`;
                    select.appendChild(opt);
                });
                
                // S√©lectionner la premi√®re par d√©faut
                selectedSessionId = data[0].id;
                chargerCarte();
            } else {
                select.innerHTML = '<option>Aucune session disponible</option>';
            }
        }

        // 3. Afficher la carte et les points
        async function chargerCarte() {
            if(!selectedSessionId) return;

            const container = document.getElementById('map-container');
            // Supprimer les anciens boutons (garder l'image)
            document.querySelectorAll('.poste-btn').forEach(e => e.remove());

            // A. R√©cup√©rer les positions (X, Y)
            const { data: positions } = await supabase.from('post_positions').select('*');
            
            // B. R√©cup√©rer les r√©servations pour savoir ce qui est pris
            const { data: resas } = await supabase
                .from('reservations')
                .select('poste_numero')
                .eq('session_id', selectedSessionId);

            const postesPris = resas ? resas.map(r => r.poste_numero) : [];

            // C. Dessiner les points
            if (positions) {
                positions.forEach(pos => {
                    const btn = document.createElement('div');
                    const isPris = postesPris.includes(pos.poste_numero);

                    btn.className = `poste-btn ${isPris ? 'occupe' : 'libre'}`;
                    btn.textContent = pos.poste_numero;
                    
                    // Positionnement dynamique depuis la base de donn√©es
                    btn.style.top = pos.top_pos;
                    btn.style.left = pos.left_pos;

                    if (!isPris) {
                        btn.onclick = () => ouvrirReservation(pos.poste_numero);
                    } else {
                        btn.title = "D√©j√† r√©serv√©";
                    }

                    container.appendChild(btn);
                });
            } else {
                console.warn("Aucune position trouv√©e. Avez-vous utilis√© l'outil de positionnement ?");
            }
        }

        // 4. Ouvrir la modale
        window.ouvrirReservation = function(numPoste) {
            selectedPoste = numPoste;
            document.getElementById('modal-title').textContent = `R√©server le Poste ${numPoste}`;
            document.getElementById('booking-modal').style.display = 'flex';
            renderPayPal();
        }

        window.fermerModal = function() {
            document.getElementById('booking-modal').style.display = 'none';
            document.getElementById('paypal-button-container').innerHTML = ''; // Nettoyer PayPal
        }

        // 5. PayPal
        function renderPayPal() {
            document.getElementById('paypal-button-container').innerHTML = '';
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    const nom = document.getElementById('nom').value;
                    const mail = document.getElementById('email').value;
                    if(!nom || !mail) {
                        alert("Merci de remplir Nom et Email");
                        return actions.reject();
                    }
                    return actions.order.create({
                        purchase_units: [{ amount: { value: '0.01' } }] // PRIX TEST
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(async function(details) {
                        await enregistrerReservation(details.id);
                    });
                }
            }).render('#paypal-button-container');
        }

        // 6. Sauvegarde finale
        async function enregistrerReservation(paypalId) {
            const clientNom = document.getElementById('nom').value;
            const clientEmail = document.getElementById('email').value;
            const clientTel = document.getElementById('tel').value;

            const { error } = await supabase.from('reservations').insert({
                session_id: selectedSessionId,
                poste_numero: selectedPoste,
                nom_client: clientNom,
                email_client: clientEmail,
                telephone_client: clientTel,
                paypal_order_id: paypalId
            });

            if (error) {
                alert("Erreur lors de l'enregistrement: " + error.message);
            } else {
                alert("R√©servation confirm√©e ! Merci " + clientNom);
                fermerModal();
                chargerCarte(); // Rafra√Æchir la carte (le poste deviendra gris)
            }
        }

        // Utilitaire date
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR');
        }

        // Lancer
        init();
    </script>
</body>
</html>
