<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Carpe de Soufflenheim - Week-ends Libre</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: white;
            border-radius: 50%;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo img {
            max-width: 100%;
            max-height: 100%;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .session-nav {
            background: #f8f9fa;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
        }

        .session-info {
            flex: 1;
            text-align: center;
        }

        .session-info h2 {
            color: #1e3c72;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .session-info p {
            color: #666;
            font-size: 1.1em;
        }

        .nav-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #2a5298;
            transform: scale(1.05);
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .pond-container {
            position: relative;
            width: 100%;
            padding: 40px;
            background: #f0f0f0;
        }

        .pond-image {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .pond-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        .fishing-spot {
            position: absolute;
            width: 60px;
            height: 60px;
            background: #4CAF50;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        @media (max-width: 768px) {
            .fishing-spot {
                width: 40px;
                height: 40px;
                font-size: 0.9em;
                border: 2px solid white;
            }
            
            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 1em;
            }

            .session-nav {
                flex-direction: column;
                gap: 15px;
            }

            .pond-container {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .fishing-spot {
                width: 35px;
                height: 35px;
                font-size: 0.8em;
                border: 2px solid white;
            }
        }

        .fishing-spot:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .fishing-spot.reserved {
            background: #999;
            cursor: not-allowed;
        }

        .fishing-spot.reserved:hover {
            transform: scale(1);
        }

        .fishing-spot.dragging {
            opacity: 0.5;
            cursor: move;
        }

        .info-panel {
            background: white;
            padding: 30px;
            text-align: center;
        }

        .price {
            font-size: 2em;
            color: #1e3c72;
            font-weight: bold;
            margin: 20px 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
            transition: all 0.3s;
        }

        .admin-link:hover {
            background: #ee5a52;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,107,0.5);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            color: #1e3c72;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #ddd;
            color: #333;
        }

        .btn-secondary:hover {
            background: #ccc;
        }

        .edit-mode-info {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 999;
            font-weight: bold;
        }

        .edit-mode-info.active {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .save-positions-btn {
            background: white;
            color: #ff9800;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .save-positions-btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img id="logoImg" src="logo.png" alt="Logo">
            </div>
            <h1>Section Carpe de Soufflenheim</h1>
            <p class="subtitle">üé£ Week-ends Libre - √âtang Landgraben</p>
        </div>

        <div class="session-nav">
            <button class="nav-btn" id="prevBtn" onclick="changeSession(-1)">‚óÑ</button>
            <div class="session-info">
                <h2 id="sessionTitle">Session 1</h2>
                <p id="sessionDate">Chargement...</p>
                <p style="margin-top: 10px; color: #4CAF50; font-weight: bold;">
                    <span id="availableSpots">10</span> postes disponibles
                </p>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="changeSession(1)">‚ñ∫</button>
        </div>

        <div class="pond-container">
            <div class="pond-image" id="pondImageContainer">
                <img id="pondImg" src="pond.jpg" alt="√âtang">
            </div>
        </div>

        <div class="info-panel">
            <h2>Tarif du week-end</h2>
            <div class="price">30‚Ç¨</div>
            <p>Paiement s√©curis√© par PayPal</p>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>Disponible</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #999;"></div>
                    <span>R√©serv√©</span>
                </div>
            </div>
        </div>
    </div>

    <div class="edit-mode-info" id="editModeInfo">
        <span>üìç Mode √©dition : Glissez-d√©posez les postes</span>
        <button class="save-positions-btn" onclick="savePositions()">üíæ Enregistrer les positions</button>
    </div>

    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>R√©server le Poste <span id="modalSpotNumber"></span></h2>
                <p style="color: #666;">Remplissez vos informations</p>
            </div>
            
            <form id="reservationForm">
                <div class="form-group">
                    <label>Nom complet *</label>
                    <input type="text" id="userName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="userEmail" required>
                </div>
                
                <div class="form-group">
                    <label>T√©l√©phone *</label>
                    <input type="tel" id="userPhone" required>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">R√©server & Payer</button>
                </div>
            </form>
        </div>
    </div>

    <a href="admin.html" class="admin-link">‚öôÔ∏è Admin</a>

    <script>
        // üî• CONFIGURATION SUPABASE (API REST - Sans SDK)
        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';

        let sessions = [];
        let currentSession = 0;
        let selectedSpot = null;
        let editMode = false;
        let spotPositions = [];
        let realtimeInterval = null;

        // API REST Supabase - GET
        async function supabaseGet() {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/sessions?select=*&order=session_id.asc`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            return await response.json();
        }

        // API REST Supabase - UPDATE
        async function supabaseUpdate(sessionId, data) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/sessions?session_id=eq.${sessionId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(data)
            });
            return response.ok;
        }

        // Charger config.json
        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                const config = await response.json();
                spotPositions = config.spotPositions;
            } catch (error) {
                spotPositions = [
                    { top: 13.378809550005503, left: 67.04166666666667 },
                    { top: 9.503245681593135, left: 71.625 },
                    { top: 76.7521179447684, left: 78.54166666666667 },
                    { top: 75.16778523489933, left: 57.875 },
                    { top: 62.66916052370998, left: 54.208333333333336 },
                    { top: 57.21201452304984, left: 49.45833333333333 },
                    { top: 65.83232478820553, left: 45.625 },
                    { top: 79.56870942898009, left: 40.791666666666664 },
                    { top: 41.368687424359116, left: 13.791666666666666 },
                    { top: 23.588953680272855, left: 21.35546875 }
                ];
            }
        }

        async function loadSessions() {
            try {
                const data = await supabaseGet();
                if (data && data.length > 0) {
                    sessions = data.map(row => ({
                        id: row.session_id,
                        date: row.date,
                        reservations: row.reservations || [],
                        closedSpots: row.closed_spots || []
                    }));
                } else {
                    sessions = [
                        { id: 1, date: '√Ä configurer', reservations: [], closedSpots: [] },
                        { id: 2, date: '√Ä configurer', reservations: [], closedSpots: [] },
                        { id: 3, date: '√Ä configurer', reservations: [], closedSpots: [] },
                        { id: 4, date: '√Ä configurer', reservations: [], closedSpots: [] }
                    ];
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function setupRealtimeListener() {
            realtimeInterval = setInterval(async () => {
                await loadSessions();
                updateDisplay();
            }, 3000);
        }

        async function init() {
            await loadConfig();
            await loadSessions();
            createFishingSpots();
            updateDisplay();
            checkEditMode();
            setupRealtimeListener();
        }

        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            editMode = urlParams.get('edit') === 'true';
            if (editMode) {
                document.getElementById('editModeInfo').classList.add('active');
                enableDragAndDrop();
            }
        }

        function enableDragAndDrop() {
            const spots = document.querySelectorAll('.fishing-spot');
            spots.forEach(spot => {
                spot.draggable = true;
                spot.style.cursor = 'move';
                
                spot.addEventListener('dragstart', (e) => {
                    spot.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                spot.addEventListener('dragend', (e) => {
                    spot.classList.remove('dragging');
                    const rect = document.getElementById('pondImageContainer').getBoundingClientRect();
                    const spotRect = spot.getBoundingClientRect();
                    
                    const spotIndex = parseInt(spot.dataset.spot) - 1;
                    spotPositions[spotIndex] = {
                        top: ((spotRect.top - rect.top + spotRect.height/2) / rect.height * 100),
                        left: ((spotRect.left - rect.left + spotRect.width/2) / rect.width * 100)
                    };
                });
            });

            const container = document.getElementById('pondImageContainer');
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    dragging.style.left = (x / rect.width * 100) + '%';
                    dragging.style.top = (y / rect.height * 100) + '%';
                }
            });
        }

        function savePositions() {
            const configContent = { spotPositions: spotPositions };
            const dataStr = JSON.stringify(configContent, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'config.json';
            link.click();
            alert('‚úÖ Positions enregistr√©es !');
        }

        function createFishingSpots() {
            const container = document.getElementById('pondImageContainer');
            const oldSpots = container.querySelectorAll('.fishing-spot');
            oldSpots.forEach(spot => spot.remove());

            for (let i = 1; i <= 10; i++) {
                const spot = document.createElement('div');
                spot.className = 'fishing-spot';
                spot.textContent = i;
                spot.dataset.spot = i;
                
                const pos = spotPositions[i - 1];
                spot.style.top = pos.top + '%';
                spot.style.left = pos.left + '%';
                spot.style.transform = 'translate(-50%, -50%)';
                
                if (!editMode) {
                    spot.onclick = () => openReservationModal(i);
                }
                
                container.appendChild(spot);
            }
        }

        function updateDisplay() {
            if (sessions.length === 0) return;
            
            const session = sessions[currentSession];
            document.getElementById('sessionTitle').textContent = `Session ${currentSession + 1}`;
            document.getElementById('sessionDate').textContent = session.date;
            
            document.getElementById('prevBtn').disabled = currentSession === 0;
            document.getElementById('nextBtn').disabled = currentSession === sessions.length - 1;
            
            const spots = document.querySelectorAll('.fishing-spot');
            let available = 10;
            
            spots.forEach(spot => {
                const spotNumber = parseInt(spot.dataset.spot);
                const isReserved = session.reservations.some(r => r.spot === spotNumber);
                const isClosed = session.closedSpots && session.closedSpots.includes(spotNumber);
                
                if (isReserved || isClosed) {
                    spot.classList.add('reserved');
                    available--;
                } else {
                    spot.classList.remove('reserved');
                }
            });
            
            document.getElementById('availableSpots').textContent = available;
        }

        function changeSession(direction) {
            const newSession = currentSession + direction;
            if (newSession >= 0 && newSession < sessions.length) {
                currentSession = newSession;
                updateDisplay();
            }
        }

        function openReservationModal(spotNumber) {
            if (editMode) return;
            
            const session = sessions[currentSession];
            const isReserved = session.reservations.some(r => r.spot === spotNumber);
            const isClosed = session.closedSpots && session.closedSpots.includes(spotNumber);
            
            if (isReserved) {
                alert('Ce poste est d√©j√† r√©serv√© pour cette session.');
                return;
            }
            
            if (isClosed) {
                alert('Ce poste est temporairement ferm√© pour cette session.');
                return;
            }
            
            selectedSpot = spotNumber;
            document.getElementById('modalSpotNumber').textContent = spotNumber;
            document.getElementById('reservationModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('reservationModal').classList.remove('active');
            document.getElementById('reservationForm').reset();
            selectedSpot = null;
        }

        document.getElementById('reservationForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const phone = document.getElementById('userPhone').value;
            
            if (confirm(`Confirmer la r√©servation du poste ${selectedSpot} pour ${name} ?\n\nVous serez redirig√© vers PayPal pour payer 30‚Ç¨.`)) {
                const session = sessions[currentSession];
                
                const newReservations = [...session.reservations, {
                    spot: selectedSpot,
                    name: name,
                    email: email,
                    phone: phone,
                    date: new Date().toISOString()
                }];
                
                const success = await supabaseUpdate(session.id, { reservations: newReservations });
                
                if (!success) {
                    alert('‚ùå Erreur lors de la r√©servation. R√©essayez.');
                    return;
                }
                
                alert('‚úÖ R√©servation enregistr√©e !');
                window.location.href = 'https://www.paypal.me/votrecompte/30EUR';
                closeModal();
            }
        };

        document.getElementById('reservationModal').onclick = function(e) {
            if (e.target === this) closeModal();
        };

        window.onbeforeunload = function() {
            if (realtimeInterval) clearInterval(realtimeInterval);
        };

        window.onload = init;
    </script>
</body>
</html>
