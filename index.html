<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week-End libre Soufflenheim</title>
    
    <!-- SDK PayPal (Mode Test 'sb' - Remplace par ton vrai Client ID pour la prod) -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0fdf4; margin: 0; padding: 20px; text-align: center; }

        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Logo */
        .logo { max-width: 120px; display: block; margin: 0 auto 10px auto; }
        h1 { color: #166534; margin-top: 0; }

        /* --- Bloc Tarif --- */
        .price-info {
            background-color: #dcfce7;
            color: #14532d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #86efac;
        }
        .price-tag { font-size: 1.4em; font-weight: bold; display: block; margin-bottom: 5px; }
        .price-details { font-size: 0.95em; display: block; margin-top: 2px; }

        /* --- Alerte Mobile --- */
        .rotate-alert {
            display: none;
            background-color: #fff7ed;
            border: 1px solid #fdba74;
            color: #c2410c;
            padding: 10px;
            border-radius: 8px;
            margin: 15px auto;
            max-width: 90%;
            font-size: 0.9em;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        @media only screen and (max-width: 768px) and (orientation: portrait) {
            .rotate-alert { display: flex; }
        }

        /* Carte */
        #map-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px auto;
            border: 4px solid #166534;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        #pond-image {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .poste-marker {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 14px;
            transform: translate(-50%, -50%);
            transition: transform 0.2s;
        }

        .libre { background-color: #22c55e; cursor: pointer; }
        .libre:hover { transform: translate(-50%, -50%) scale(1.2); z-index: 10; }
        .occupe { background-color: #ef4444; cursor: not-allowed; opacity: 0.8; }
        .selectionne { background-color: #fbbf24; border-color: #000; transform: translate(-50%, -50%) scale(1.3); z-index: 20; color: black; }

        /* Formulaire */
        select, input { padding: 10px; margin: 5px; width: 90%; max-width: 300px; border: 1px solid #ccc; border-radius: 5px; }
        
        /* Conteneur PayPal */
        #paypal-button-container {
            margin-top: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .hidden { display: none; }

        .admin-link {
            display: inline-block;
            margin-top: 30px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .admin-link:hover { background: #f1f5f9; color: #475569; }
    </style>
</head>
<body>

    <div class="container">
        <!-- LOGO -->
        <img src="logo.png" alt="Section Carpe Logo" class="logo">
        <h1>üé£ Section Carpe de Soufflenheim</h1>

        <!-- Info Tarif -->
        <div class="price-info">
            <span class="price-tag">Tarif : 60‚Ç¨ / Week-end</span>
            <span class="price-details">Ce prix inclut 1 ou 2 p√™cheurs par poste (tarif unique).</span>
            <span class="price-details">Toutes sortes de bateaux interdits, sauf le bateau amorceur est autoris√©.</span>
            <span class="price-details">3 cannes maximum par p√™cheur.</span>
        </div>

        <!-- √âtape 1 -->
        <label><strong>1. Choisissez une session :</strong></label><br>
        <select id="sessionSelect">
            <option value="">Chargement des dates...</option>
        </select>

        <!-- √âtape 2 : Carte -->
        <div id="map-section" class="hidden">

            <!-- Alerte Mobile -->
            <div class="rotate-alert">
                <span style="font-size: 20px;">üîÑ</span>
                <div><strong>Conseil :</strong> Tournez votre t√©l√©phone √† l'horizontale pour mieux voir les postes.</div>
            </div>

            <p><strong>2. Cliquez sur un poste vert (üü¢) :</strong></p>

            <div id="map-wrapper">
                <img src="pond.jpg" id="pond-image" alt="Plan de l'√©tang">
                <!-- JS ins√®re les bulles ici -->
            </div>
        </div>

        <!-- √âtape 3 : Formulaire et Paiement -->
        <div id="form-section" class="hidden">
            <h3>R√©servation du Poste N¬∞ <span id="displayPoste">?</span></h3>

            <p style="color: #555; font-size: 0.9em; margin-bottom: 15px;">
                Veuillez remplir vos coordonn√©es ci-dessous.<br>
                Le paiement s√©curis√© de <strong>60‚Ç¨</strong> validera la r√©servation.
            </p>

            <input type="text" id="nom" placeholder="Votre Nom (et celui du bin√¥me si applicable)">
            <input type="email" id="email" placeholder="Votre Email (pour confirmation)">
            <input type="tel" id="tel" placeholder="T√©l√©phone">
            
            <!-- Zone PayPal -->
            <div id="paypal-button-container" style="min-height: 150px; margin-top: 20px;">
    <p id="paypal-loading" style="color: orange; font-weight: bold;">
        ‚åõ Chargement de PayPal...<br>
        <span style="font-size:0.8em; color: black; font-weight: normal;">
        (Si ce message reste affich√©, v√©rifiez votre connexion ou d√©sactivez AdBlock)
        </span>
    </p>
</div>

        <br>
        <a href="admin.html" class="admin-link">üîí Administration</a>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentSessionId = null;
        let selectedPoste = null;
        let postesCoords = [];

        async function init() {
            // Charger Coordonn√©es
            const { data: configs } = await supabase.from('postes_config').select('*');
            postesCoords = configs || [];

            // Charger Sessions futures
            const { data: sessions } = await supabase
                .from('sessions')
                .select('*')
                .gte('date_fin', new Date().toISOString().split('T')[0]) 
                .order('date_debut');

            const select = document.getElementById('sessionSelect');
            select.innerHTML = '<option value="">-- S√©lectionnez une date --</option>';

            if(sessions) {
                sessions.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.nom} (${s.date_debut} au ${s.date_fin})`;
                    select.appendChild(opt);
                });
            }

            select.addEventListener('change', (e) => {
                currentSessionId = e.target.value;
                if(currentSessionId) {
                    loadMapStatus();
                    document.getElementById('map-section').classList.remove('hidden');
                } else {
                    document.getElementById('map-section').classList.add('hidden');
                    document.getElementById('form-section').classList.add('hidden');
                }
            });

            // Initialiser les boutons PayPal une seule fois
           function renderPayPalButton() {
    // V√©rification de s√©curit√©
    if (typeof paypal === 'undefined') {
        document.getElementById('paypal-loading').innerHTML = 
            "‚ùå <strong>Erreur :</strong> Le module PayPal n'a pas charg√©.<br>" +
            "V√©rifiez que la ligne &lt;script src='...paypal...'&gt; est bien dans le &lt;head&gt;.";
        return;
    }

    try {
        paypal.Buttons({
            // V√©rifier les champs avant d'ouvrir PayPal
            onClick: (data, actions) => {
                const nom = document.getElementById('nom').value;
                const email = document.getElementById('email').value;
                const tel = document.getElementById('tel').value;
                const poste = document.getElementById('displayPoste').innerText;

                if (!nom || !email || !tel || poste === '?') {
                    alert("Veuillez remplir TOUS les champs avant de payer.");
                    return actions.reject();
                }
                return actions.resolve();
            },
            createOrder: (data, actions) => {
                return actions.order.create({
                    purchase_units: [{
                        description: `R√©servation Poste ${selectedPoste}`,
                        amount: { value: '60.00' }
                    }]
                });
            },
            onApprove: (data, actions) => {
                return actions.order.capture().then(async (details) => {
                    // Masquer le formulaire pour √©viter double clic
                    document.getElementById('form-section').innerHTML = "<h3>‚úÖ Paiement valid√© ! Enregistrement...</h3>";
                    
                    const nom = document.getElementById('nom').value;
                    const email = document.getElementById('email').value;
                    const tel = document.getElementById('tel').value;

                    const { error } = await supabase.from('reservations').insert({
                        session_id: currentSessionId,
                        poste_numero: selectedPoste,
                        nom_client: nom,
                        email_client: email,
                        telephone_client: tel
                    });

                    if(error) {
                        alert("Paiement re√ßu mais erreur d'enregistrement base de donn√©es. Contactez l'admin.");
                    } else {
                        alert("‚úÖ R√©servation confirm√©e !");
                        location.reload();
                    }
                });
            },
            onError: (err) => {
                console.error('Erreur PayPal:', err);
                alert("Erreur lors de l'initialisation du paiement.");
            }
        }).render('#paypal-button-container');
    } catch (error) {
        console.error("Crash PayPal:", error);
        document.getElementById('paypal-loading').innerText = "Erreur technique PayPal (voir console F12)";
    }
}


        async function loadMapStatus() {
            const wrapper = document.getElementById('map-wrapper');
            document.querySelectorAll('.poste-marker').forEach(el => el.remove());

            const { data: resas } = await supabase
                .from('reservations')
                .select('poste_numero')
                .eq('session_id', currentSessionId);

            const taken = resas ? resas.map(r => r.poste_numero) : [];

            for(let i=1; i<=10; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'poste-marker';
                bubble.innerText = i;

                const config = postesCoords.find(c => c.poste_id === i);
                let left = '50%', top = '50%'; 
                if(config) {
                    left = config.pos_x + '%';
                    top = config.pos_y + '%';
                }

                bubble.style.left = left;
                bubble.style.top = top;

                if(taken.includes(i)) {
                    bubble.classList.add('occupe');
                    bubble.title = "D√©j√† r√©serv√©";
                } else {
                    bubble.classList.add('libre');
                    bubble.onclick = () => selectPoste(i, bubble);
                }

                wrapper.appendChild(bubble);
            }
        }

        function selectPoste(id, element) {
            document.querySelectorAll('.selectionne').forEach(el => el.classList.remove('selectionne'));
            element.classList.add('selectionne');
            selectedPoste = id;

            document.getElementById('displayPoste').innerText = id;
            document.getElementById('form-section').classList.remove('hidden');
            document.getElementById('form-section').scrollIntoView({behavior: "smooth"});
        }

        // --- FONCTION PAYPAL ---
        function renderPayPalButton() {
            paypal.Buttons({
                // V√©rifier les champs avant d'ouvrir PayPal
                onClick: (data, actions) => {
                    const nom = document.getElementById('nom').value;
                    const email = document.getElementById('email').value;
                    const tel = document.getElementById('tel').value;

                    if (!nom || !email || !tel || !selectedPoste) {
                        alert("Veuillez remplir TOUS les champs avant de payer.");
                        return actions.reject();
                    }
                    return actions.resolve();
                },
                // Cr√©er la transaction
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: `R√©servation Poste ${selectedPoste} - Soufflenheim`,
                            amount: {
                                value: '60.00' // PRIX ICI
                            }
                        }]
                    });
                },
                // Quand le paiement est valid√©
                onApprove: (data, actions) => {
                    return actions.order.capture().then(async (details) => {
                        // Paiement OK, on ins√®re dans Supabase
                        console.log('Paiement r√©ussi par ' + details.payer.name.given_name);
                        
                        const nom = document.getElementById('nom').value;
                        const email = document.getElementById('email').value;
                        const tel = document.getElementById('tel').value;

                        const { error } = await supabase.from('reservations').insert({
                            session_id: currentSessionId,
                            poste_numero: selectedPoste,
                            nom_client: nom,
                            email_client: email,
                            telephone_client: tel
                            // On pourrait ajouter une colonne 'paypal_order_id': details.id si tu l'as cr√©√©e
                        });

                        if(error) {
                            alert("Paiement valid√© mais erreur technique lors de l'enregistrement. Contactez-nous.");
                            console.error(error);
                        } else {
                            alert("‚úÖ Paiement de 60‚Ç¨ re√ßu ! Votre r√©servation est valid√©e.");
                            location.reload();
                        }
                    });
                },
                onError: (err) => {
                    console.error('Erreur PayPal', err);
                    alert("Le paiement n'a pas pu aboutir.");
                }
            }).render('#paypal-button-container');
        }

        init();
    </script>
</body>
</html>

