<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation √âtang - Section Carpe Soufflenheim</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0fdf4; margin: 0; padding: 20px; text-align: center; }
        
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Logo */
        .logo { max-width: 120px; display: block; margin: 0 auto 10px auto; }
        h1 { color: #166534; margin-top: 0; }

        /* Infos Tarif */
        .price-info {
            background-color: #dcfce7;
            color: #14532d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #86efac;
        }
        .price-tag { font-size: 1.4em; font-weight: bold; display: block; margin-bottom: 5px; }
        .price-details { font-size: 0.9em; }

        /* Alerte Mobile (Rotation) */
        .rotate-alert {
            display: none; /* Cach√© par d√©faut */
            background-color: #fff7ed;
            border: 1px solid #fdba74;
            color: #c2410c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Afficher l'alerte uniquement sur petits √©crans en mode portrait */
        @media only screen and (max-width: 768px) and (orientation: portrait) {
            .rotate-alert { display: flex; }
        }

        /* Carte */
        #map-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px auto;
            border: 4px solid #166534;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        #pond-image {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .poste-marker {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 14px;
            transform: translate(-50%, -50%);
            transition: transform 0.2s;
            cursor: pointer;
        }

        /* Couleurs */
        .libre { background-color: #22c55e; } /* Vert */
        .libre:hover { transform: translate(-50%, -50%) scale(1.2); }
        .occupe { background-color: #ef4444; cursor: not-allowed; opacity: 0.8; } /* Rouge */
        .selectionne { background-color: #3b82f6; transform: translate(-50%, -50%) scale(1.3); border: 2px solid #1e40af; } /* Bleu */

        /* Formulaire */
        .hidden { display: none; }
        #form-section { margin-top: 20px; padding: 20px; background-color: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        input { padding: 10px; width: 80%; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button.btn-primary {
            background-color: #166534; color: white; padding: 12px 24px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;
        }
        button.btn-primary:hover { background-color: #14532d; }

        /* Navigation Session */
        .session-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .nav-arrow { font-size: 24px; cursor: pointer; user-select: none; }
        .nav-arrow:hover { transform: scale(1.2); }

        /* Footer */
        footer { margin-top: 40px; font-size: 0.8em; color: #64748b; }
        footer a { color: #64748b; text-decoration: none; }
    </style>
    <!-- Chargement Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="container">
        <img src="logo.png" alt="Logo Section Carpe" class="logo">
        <h1>R√©servation Week-end Libre</h1>

        <!-- Info Tarif -->
        <div class="price-info">
            <span class="price-tag">Tarif : 60‚Ç¨ / Week-end</span>
            <span class="price-details">Ce prix inclut 1 ou 2 p√™cheurs par poste (tarif unique).</span>
        </div>

        <!-- Navigation Session -->
        <div class="session-nav">
            <span class="nav-arrow" onclick="changeSession(-1)">‚¨ÖÔ∏è</span>
            <h2 id="sessionTitle" style="margin:0;">Chargement...</h2>
            <span class="nav-arrow" onclick="changeSession(1)">‚û°Ô∏è</span>
        </div>

        <!-- Alerte Mobile pour tourner l'√©cran -->
        <div class="rotate-alert">
            <span style="font-size: 24px;">üîÑ</span>
            <div>
                <strong>Conseil :</strong> Tournez votre t√©l√©phone √† l'horizontale pour mieux voir les postes.
            </div>
        </div>

        <p>Cliquez sur un poste <strong>VERT</strong> pour le r√©server.</p>

        <div id="map-wrapper">
            <!-- L'image doit s'appeler pond.jpg -->
            <img id="pond-image" src="pond.jpg" alt="Plan de l'√©tang">
            <div id="postes-layer"></div>
        </div>

        <!-- Formulaire de r√©servation -->
        <div id="form-section" class="hidden">
            <h3>üé£ R√©server le Poste N¬∞<span id="displayPoste"></span></h3>
            
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Vous r√©servez pour <strong>60‚Ç¨</strong>.<br>
                Vous pouvez venir seul ou accompagn√© d'un deuxi√®me p√™cheur sur ce poste.
            </p>

            <input type="text" id="nom" placeholder="Votre Nom complet" required><br>
            <input type="email" id="email" placeholder="Votre Email" required><br>
            <input type="tel" id="tel" placeholder="Votre T√©l√©phone" required><br>
            
            <button id="btnReserver" class="btn-primary">Valider et Payer (Simulation)</button>
        </div>

    </div>

    <footer>
        &copy; Section Carpe Soufflenheim - <a href="admin.html">Administration</a>
    </footer>

    <script>
        // --- CONFIGURATION SUPABASE ---
        // REMPLACE AVEC TES CLES
        const SUPABASE_URL = "TON_URL_SUPABASE";
        const SUPABASE_KEY = "TA_CLE_PUBLIQUE_SUPABASE";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allSessions = [];
        let currentSessionIndex = 0;
        let currentSessionId = null;
        let selectedPoste = null;
        let positionsCache = [];

        async function init() {
            await loadSessions();
            await loadPositions(); 
            if(currentSessionId) loadMapStatus();
        }

        async function loadSessions() {
            const { data, error } = await supabase
                .from('sessions')
                .select('*')
                .order('created_at', { ascending: true });

            if (data && data.length > 0) {
                allSessions = data;
                const activeIndex = allSessions.findIndex(s => s.active === true);
                currentSessionIndex = activeIndex !== -1 ? activeIndex : allSessions.length - 1;
                updateSessionDisplay();
            } else {
                document.getElementById('sessionTitle').innerText = "Aucune session ouverte";
            }
        }

        function updateSessionDisplay() {
            if(allSessions.length === 0) return;
            const session = allSessions[currentSessionIndex];
            currentSessionId = session.id;
            document.getElementById('sessionTitle').innerText = session.nom;
            document.getElementById('form-section').classList.add('hidden');
            selectedPoste = null;
            loadMapStatus();
        }

        function changeSession(direction) {
            if (allSessions.length === 0) return;
            currentSessionIndex += direction;
            if (currentSessionIndex < 0) currentSessionIndex = 0;
            if (currentSessionIndex >= allSessions.length) currentSessionIndex = allSessions.length - 1;
            updateSessionDisplay();
        }

        async function loadPositions() {
            const { data } = await supabase.from('postes_config').select('*');
            if(data) positionsCache = data;
        }

        async function loadMapStatus() {
            const { data: resas } = await supabase
                .from('reservations')
                .select('poste_numero')
                .eq('session_id', currentSessionId);

            const occupiedPostes = resas ? resas.map(r => r.poste_numero) : [];
            const wrapper = document.getElementById('postes-layer');
            wrapper.innerHTML = ''; 

            for (let i = 1; i <= 10; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'poste-marker';
                bubble.innerText = i;

                const config = positionsCache.find(p => p.poste_numero === i);
                if (config) {
                    bubble.style.left = config.x + '%';
                    bubble.style.top = config.y + '%';
                } else {
                    bubble.style.left = (i * 8) + '%'; 
                    bubble.style.top = '50%';
                }

                if (occupiedPostes.includes(i)) {
                    bubble.classList.add('occupe');
                    bubble.title = "D√©j√† r√©serv√©";
                } else {
                    bubble.classList.add('libre');
                    bubble.onclick = () => selectPoste(i, bubble);
                }

                wrapper.appendChild(bubble);
            }
        }

        function selectPoste(id, element) {
            document.querySelectorAll('.selectionne').forEach(el => el.classList.remove('selectionne'));
            element.classList.add('selectionne');
            selectedPoste = id;
            document.getElementById('displayPoste').innerText = id;
            document.getElementById('form-section').classList.remove('hidden');
            document.getElementById('form-section').scrollIntoView({behavior: "smooth"});
        }

        document.getElementById('btnReserver').addEventListener('click', async () => {
            const nom = document.getElementById('nom').value;
            const email = document.getElementById('email').value;
            const tel = document.getElementById('tel').value;

            if(!nom || !email || !selectedPoste) return alert("Merci de tout remplir");

            const { error } = await supabase.from('reservations').insert({
                session_id: currentSessionId,
                poste_numero: selectedPoste,
                nom_client: nom,
                email_client: email,
                telephone_client: tel
            });

            if(error) {
                alert("Erreur : Ce poste vient d'√™tre pris √† l'instant !");
                loadMapStatus();
            } else {
                alert("‚úÖ R√©servation r√©ussie pour 60‚Ç¨ !");
                location.reload();
            }
        });

        init();
    </script>
</body>
</html>
