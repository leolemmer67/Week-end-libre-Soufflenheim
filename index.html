<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Carpe de Soufflenheim - Réservation</title>
    <!-- CSS -->
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* Header & Nav */
        header { text-align: center; margin-bottom: 30px; }
        .logo { width: 100px; }
        .nav-sessions { display: flex; justify-content: space-between; align-items: center; background: #eef2f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .btn-nav { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1.2rem; }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Carte Interactive */
        .map-container { position: relative; width: 100%; max-width: 1000px; margin: 0 auto; }
        .map-img { width: 100%; border-radius: 10px; display: block; }
        
        .poste {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; cursor: pointer;
            transform: translate(-50%, -50%); /* Pour centrer le point */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .poste:hover { transform: translate(-50%, -50%) scale(1.2); }
        .libre { background-color: #2ecc71; } /* Vert */
        .pris { background-color: #e74c3c; cursor: not-allowed; } /* Rouge */
        
        /* Modal de réservation */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;}
        .close-btn { background: #95a5a6; margin-top: 10px; }
    </style>

    <!-- SDK Supabase (Version Module - Pas d'erreur eval) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SDK PayPal (Remplace CLIENT_ID par le tien plus tard) -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script> 
</head>
<body>

<div class="container">
    <header>
        <img src="logo.png" alt="Logo Carpe" class="logo">
        <h1>Section Carpe de Soufflenheim</h1>
        <p>Réservation Week-end Libre</p>
    </header>

    <div class="nav-sessions">
        <button class="btn-nav" id="prevBtn" onclick="changeSession(-1)">◄</button>
        <div id="sessionInfo">
            <h2 id="sessionName">Chargement...</h2>
            <p id="sessionDates"></p>
        </div>
        <button class="btn-nav" id="nextBtn" onclick="changeSession(1)">►</button>
    </div>

    <div class="map-container">
        <img src="pond.jpg" alt="Etang" class="map-img">
        <!-- Les postes seront injectés ici par JS -->
        <div id="postes-layer"></div>
    </div>
</div>

<!-- Modal Réservation -->
<div id="modal">
    <div class="modal-content">
        <h2>Réserver Poste <span id="modalPosteNum"></span></h2>
        <p>Prix : 30€ le week-end</p>
        <div id="form-inputs">
            <input type="text" id="nom" placeholder="Votre Nom complet">
            <input type="email" id="email" placeholder="Votre Email">
            <input type="tel" id="tel" placeholder="Votre Téléphone">
        </div>
        <!-- Bouton PayPal s'affichera ici -->
        <div id="paypal-button-container" style="margin-top:15px;"></div>
        <button class="btn-nav close-btn" onclick="closeModal()">Annuler</button>
    </div>
</div>

<script type="module">
    // 1. CONFIGURATION (METS TES CLES ICI)
    const SUPABASE_URL = 'https://TON_URL_SUPABASE.supabase.co';
    const SUPABASE_KEY = 'TA_CLE_PUBLIQUE_ANON';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 2. DONNEES & ETATS
    let sessions = [];
    let currentSessionIndex = 0;
    let reservationsActuelles = [];
    
    // Coordonnées exactes des postes (en %)
    // Tu devras ajuster ces valeurs avec le mode "Edit" ou à tâtons
    const positionsPostes = [
        {x: 67, y: 13}, {x: 71, y: 9}, {x: 78, y: 76}, {x: 57, y: 75}, 
        {x: 54, y: 62}, {x: 49, y: 57}, {x: 45, y: 65}, {x: 40, y: 79}, 
        {x: 13, y: 41}, {x: 21, y: 23}
    ];

    // 3. CHARGEMENT INITIAL
    async function init() {
        // Récupérer les sessions depuis Supabase
        const { data, error } = await supabase
            .from('sessions')
            .select('*')
            .order('date_debut', { ascending: true });
            
        if(error) console.error(error);
        if(data) {
            sessions = data;
            chargerSession(0);
        }
    }

    // 4. GESTION DES SESSIONS
    window.changeSession = (direction) => {
        const newIndex = currentSessionIndex + direction;
        if (newIndex >= 0 && newIndex < sessions.length) {
            chargerSession(newIndex);
        }
    };

    async function chargerSession(index) {
        currentSessionIndex = index;
        const session = sessions[index];
        
        // Mise à jour UI Textes
        document.getElementById('sessionName').innerText = session.nom;
        document.getElementById('sessionDates').innerText = 
            `Du ${new Date(session.date_debut).toLocaleDateString()} au ${new Date(session.date_fin).toLocaleDateString()}`;
        
        document.getElementById('prevBtn').disabled = (index === 0);
        document.getElementById('nextBtn').disabled = (index === sessions.length - 1);

        // Récupérer les réservations pour CETTE session
        const { data: resas } = await supabase
            .from('reservations')
            .select('poste_numero')
            .eq('session_id', session.id);
            
        reservationsActuelles = resas.map(r => r.poste_numero);
        afficherPostes();
    }

    // 5. AFFICHAGE DES POSTES
    function afficherPostes() {
        const layer = document.getElementById('postes-layer');
        layer.innerHTML = ''; // Nettoyer

        positionsPostes.forEach((pos, i) => {
            const num = i + 1;
            const estPris = reservationsActuelles.includes(num);
            
            const btn = document.createElement('div');
            btn.className = `poste ${estPris ? 'pris' : 'libre'}`;
            btn.style.left = pos.x + '%';
            btn.style.top = pos.y + '%';
            btn.innerText = num;
            
            if (!estPris) {
                btn.onclick = () => ouvrirReservation(num);
            }
            
            layer.appendChild(btn);
        });
    }

    // 6. GESTION RESERVATION & PAYPAL
    let selectedPoste = null;

    window.ouvrirReservation = (num) => {
        selectedPoste = num;
        document.getElementById('modalPosteNum').innerText = num;
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('paypal-button-container').innerHTML = ''; // Reset bouton

        // Rendu du bouton PayPal
        paypal.Buttons({
            createOrder: function(data, actions) {
                // Validation simple
                const nom = document.getElementById('nom').value;
                if(!nom) { alert('Merci de mettre votre nom'); return; }
                
                return actions.order.create({
                    purchase_units: [{ amount: { value: '30.00' } }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(async function(details) {
                    // PAIEMENT REUSSI -> ENREGISTREMENT EN BASE
                    await sauvegarderReservation(details.id);
                });
            }
        }).render('#paypal-button-container');
    };

    window.closeModal = () => {
        document.getElementById('modal').style.display = 'none';
    };

    async function sauvegarderReservation(transactionId) {
        const session = sessions[currentSessionIndex];
        const nom = document.getElementById('nom').value;
        const email = document.getElementById('email').value;
        const tel = document.getElementById('tel').value;

        const { error } = await supabase.from('reservations').insert({
            session_id: session.id,
            poste_numero: selectedPoste,
            nom_client: nom,
            email_client: email,
            telephone_client: tel,
            paypal_order_id: transactionId
        });

        if (error) {
            alert("Erreur lors de l'enregistrement. Contactez l'admin avec ce code : " + transactionId);
            console.error(error);
        } else {
            alert("Réservation confirmée ! Merci.");
            closeModal();
            chargerSession(currentSessionIndex); // Rafraichir la carte
        }
    }

    // Démarrage
    init();
</script>
</body>
</html>
