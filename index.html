<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üõ°Ô∏è S√âCURIT√â : Autorise ton projet Supabase et PayPal -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://drhsdlzhxkbamwcskblr.supabase.co https://*.supabase.co https://*.supabase.in https://*.paypal.com https://*.paypalobjects.com data: blob:;">

    <title>R√©servation √âtang de Soufflenheim</title>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #f0fdf4; text-align: center; }
        
        /* En-t√™te */
        header { background: #166534; color: white; padding: 1rem; }
        .session-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }
        .nav-arrow { cursor: pointer; font-size: 1.5rem; user-select: none; }
        .nav-arrow:hover { color: #86efac; }
        
        /* Carte */
        .map-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            border: 5px solid #166534;
            border-radius: 8px;
            overflow: hidden;
        }
        .map-container img { width: 100%; display: block; }

        /* Boutons des postes */
        .poste-btn {
            position: absolute;
            width: 40px; height: 40px;
            background: #22c55e; /* Vert */
            color: white; border: 2px solid white; border-radius: 50%;
            cursor: pointer; font-weight: bold;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            z-index: 10;
        }
        .poste-btn:hover { transform: translate(-50%, -50%) scale(1.2); z-index: 20; }
        .poste-btn.taken { background: #ef4444; cursor: not-allowed; } /* Rouge */

        /* Modal */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; text-align: left; }
        input { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .close { float: right; cursor: pointer; font-size: 1.5rem; }

        /* Bouton Admin en bas */
        .admin-link { 
            display: inline-block; margin-top: 30px; margin-bottom: 20px;
            background: #334155; color: white; text-decoration: none; 
            padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; opacity: 0.8;
        }
        .admin-link:hover { opacity: 1; }
    </style>
</head>
<body>

<header>
    <h1>üé£ √âtang de Soufflenheim</h1>
    <div class="session-nav">
        <span class="nav-arrow" onclick="changeSession(-1)">‚¨ÖÔ∏è</span>
        <h2 id="sessionTitle">Chargement...</h2>
        <span class="nav-arrow" onclick="changeSession(1)">‚û°Ô∏è</span>
    </div>
</header>

<div class="map-container">
    <img src="pond.jpg" alt="Plan de l'√©tang" onerror="this.src='https://via.placeholder.com/1000x600?text=Image+Introuvable';">
    <div id="postes-layer"></div>
</div>

<p>Cliquez sur un poste vert pour r√©server (30‚Ç¨ / week-end).</p>

<a href="admin.html" class="admin-link">üîí Acc√®s Propri√©taire</a>

<!-- Modal -->
<div id="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">R√©server</h3>
        <p>Vos coordonn√©es :</p>
        <input type="text" id="nom" placeholder="Nom complet">
        <input type="email" id="email" placeholder="Email">
        <input type="tel" id="tel" placeholder="T√©l√©phone">
        <div id="paypal-button-container"></div>
    </div>
</div>

<script>
    // ‚úÖ TES CL√âS SUPABASE CORRECTEMENT CONFIGUR√âES
    const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // üìç Positions des postes (Tu peux ajuster les % ici)
    const postesConfig = [
        { id: 1, x: 20, y: 30 }, { id: 2, x: 30, y: 25 },
        { id: 3, x: 45, y: 20 }, { id: 4, x: 60, y: 20 },
        { id: 5, x: 75, y: 30 }, { id: 6, x: 85, y: 50 },
        { id: 7, x: 75, y: 70 }, { id: 8, x: 50, y: 80 },
        { id: 9, x: 25, y: 75 }, { id: 10, x: 15, y: 50 }
    ];

    let sessions = [];
    let currentSessionIndex = 0;
    let selectedPoste = null;

    async function init() {
        console.log("Connexion Supabase...");
        
        // R√©cup√©rer les sessions
        const { data, error } = await supabase
            .from('sessions')
            .select('*')
            .order('date_debut', { ascending: true });

        if (error) {
            console.error("Erreur connexion:", error);
            document.getElementById('sessionTitle').innerText = "Erreur technique (voir console)";
            return;
        }

        if (!data || data.length === 0) {
            document.getElementById('sessionTitle').innerText = "Aucune session planifi√©e.";
            return;
        }

        sessions = data;
        chargerSession(0);
    }

    async function chargerSession(index) {
        if (index < 0) index = 0;
        if (index >= sessions.length) index = sessions.length - 1;
        currentSessionIndex = index;

        const session = sessions[currentSessionIndex];
        
        // Formatage date
        const options = { day: 'numeric', month: 'long' };
        const d1 = new Date(session.date_debut).toLocaleDateString('fr-FR', options);
        const d2 = new Date(session.date_fin).toLocaleDateString('fr-FR', options);
        document.getElementById('sessionTitle').innerText = `${session.nom} (${d1} - ${d2})`;

        // V√©rifier les postes d√©j√† pris
        const { data: resas } = await supabase
            .from('reservations')
            .select('poste_numero')
            .eq('session_id', session.id);

        const postesPris = resas ? resas.map(r => r.poste_numero) : [];
        afficherPostes(postesPris);
    }

    function afficherPostes(pris) {
        const container = document.getElementById('postes-layer');
        container.innerHTML = ''; 

        postesConfig.forEach(poste => {
            const btn = document.createElement('button');
            btn.className = 'poste-btn';
            btn.innerText = poste.id;
            btn.style.left = poste.x + '%';
            btn.style.top = poste.y + '%';

            if (pris.includes(poste.id)) {
                btn.classList.add('taken');
                btn.title = "D√©j√† r√©serv√©";
            } else {
                btn.onclick = () => ouvrirReservation(poste.id);
            }
            container.appendChild(btn);
        });
    }

    function changeSession(dir) { chargerSession(currentSessionIndex + dir); }

    function ouvrirReservation(numero) {
        selectedPoste = numero;
        document.getElementById('modalTitle').innerText = `R√©server le Poste ${numero}`;
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('paypal-button-container').innerHTML = ''; 

        paypal.Buttons({
            createOrder: function(data, actions) {
                const nom = document.getElementById('nom').value;
                const email = document.getElementById('email').value;
                if(!nom || !email) {
                    alert("Merci de remplir votre nom et email.");
                    return actions.reject();
                }
                return actions.order.create({ purchase_units: [{ amount: { value: '30.00' } }] });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(details => enregistrerReservation(details.id));
            }
        }).render('#paypal-button-container');
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function enregistrerReservation(transactionId) {
        const { error } = await supabase.from('reservations').insert({
            session_id: sessions[currentSessionIndex].id,
            poste_numero: selectedPoste,
            nom_client: document.getElementById('nom').value,
            email_client: document.getElementById('email').value,
            telephone_client: document.getElementById('tel').value,
            paypal_order_id: transactionId
        });

        if (error) {
            console.error(error);
            alert("Erreur lors de l'enregistrement. Code PayPal: " + transactionId);
        } else {
            alert("‚úÖ R√©servation confirm√©e !");
            closeModal();
            chargerSession(currentSessionIndex);
        }
    }

    init();
</script>
</body>
</html>
