<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RÃ©servation Ã‰tang</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0fdf4; margin: 0; padding: 20px; text-align: center; }

        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Logo */
        .logo { max-width: 120px; display: block; margin: 0 auto 10px auto; }
        h1 { color: #166534; margin-top: 0; }

        /* --- NOUVEAU : Bloc Tarif --- */
        .price-info {
            background-color: #dcfce7;
            color: #14532d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #86efac;
        }
        .price-tag { font-size: 1.4em; font-weight: bold; display: block; margin-bottom: 5px; }
        .price-details { font-size: 0.95em; }

        /* --- NOUVEAU : Alerte Mobile (Rotation) --- */
        .rotate-alert {
            display: none; /* CachÃ© par dÃ©faut */
            background-color: #fff7ed;
            border: 1px solid #fdba74;
            color: #c2410c;
            padding: 10px;
            border-radius: 8px;
            margin: 15px auto;
            max-width: 90%;
            font-size: 0.9em;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        /* S'affiche uniquement sur Ã©cran < 768px et en mode Portrait */
        @media only screen and (max-width: 768px) and (orientation: portrait) {
            .rotate-alert { display: flex; }
        }

        /* Carte */
        #map-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px auto;
            border: 4px solid #166534;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        #pond-image {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .poste-marker {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 14px;
            transform: translate(-50%, -50%);
            transition: transform 0.2s;
        }

        /* Couleurs */
        .libre { background-color: #22c55e; cursor: pointer; }
        .libre:hover { transform: translate(-50%, -50%) scale(1.2); z-index: 10; }
        .occupe { background-color: #ef4444; cursor: not-allowed; opacity: 0.8; }
        .selectionne { background-color: #fbbf24; border-color: #000; transform: translate(-50%, -50%) scale(1.3); z-index: 20; color: black; }

        /* Formulaire */
        select, input, button { padding: 10px; margin: 5px; width: 90%; max-width: 300px; border: 1px solid #ccc; border-radius: 5px; }
        button { background-color: #166534; color: white; font-weight: bold; cursor: pointer; border: none; font-size: 1.1em; margin-top: 15px; }
        button:hover { background-color: #14532d; }

        .hidden { display: none; }

        /* Lien Admin discret en bas */
        .admin-link {
            display: inline-block;
            margin-top: 30px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .admin-link:hover { background: #f1f5f9; color: #475569; }
    </style>
</head>
<body>

    <div class="container">
        <!-- LOGO -->
        <img src="logo.png" alt="Section Carpe Logo" class="logo">
        <h1>ðŸŽ£ Section Carpe de Soufflenheim</h1>

        <!-- Info Tarif (AjoutÃ©) -->
        <div class="price-info">
            <span class="price-tag">Tarif Unique : 60â‚¬ / Poste</span>
            <span class="price-details">Valable pour 1 ou 2 pÃªcheurs sur le mÃªme poste.</span>
        </div>

        <!-- Ã‰tape 1 -->
        <label><strong>1. Choisissez une session :</strong></label><br>
        <select id="sessionSelect">
            <option value="">Chargement des dates...</option>
        </select>

        <!-- Ã‰tape 2 : Carte -->
        <div id="map-section" class="hidden">
            
            <!-- Alerte Mobile (AjoutÃ©) -->
            <div class="rotate-alert">
                <span style="font-size: 20px;">ðŸ”„</span>
                <div><strong>Conseil :</strong> Tournez votre tÃ©lÃ©phone Ã  l'horizontale pour mieux voir les postes.</div>
            </div>

            <p><strong>2. Cliquez sur un poste vert (ðŸŸ¢) :</strong></p>

            <div id="map-wrapper">
                <!-- IMAGE ETANG -->
                <img src="pond.jpg" id="pond-image" alt="Plan de l'Ã©tang">
                <!-- JS insÃ¨re les bulles ici -->
            </div>
        </div>

        <!-- Ã‰tape 3 : Formulaire -->
        <div id="form-section" class="hidden">
            <h3>RÃ©servation du Poste NÂ° <span id="displayPoste">?</span></h3>
            
            <!-- Rappel Tarif dans le formulaire (AjoutÃ©) -->
            <p style="color: #555; font-size: 0.9em; margin-bottom: 15px;">
                Vous rÃ©servez ce poste pour <strong>60â‚¬</strong>.<br>
                Le tarif est le mÃªme que vous soyez seul ou Ã  deux.
            </p>

            <input type="text" id="nom" placeholder="Votre Nom">
            <input type="email" id="email" placeholder="Votre Email">
            <input type="tel" id="tel" placeholder="TÃ©lÃ©phone">
            <button id="btnReserver">Valider la RÃ©servation</button>
        </div>

        <!-- LIEN VERS L'ADMIN -->
        <br>
        <a href="admin.html" class="admin-link">ðŸ”’ Administration</a>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentSessionId = null;
        let selectedPoste = null;
        let postesCoords = [];

        async function init() {
            // Charger CoordonnÃ©es
            const { data: configs } = await supabase.from('postes_config').select('*');
            postesCoords = configs || [];

            // Charger Sessions futures
            const { data: sessions } = await supabase
                .from('sessions')
                .select('*')
                .gte('date_fin', new Date().toISOString().split('T')[0]) 
                .order('date_debut');

            const select = document.getElementById('sessionSelect');
            select.innerHTML = '<option value="">-- SÃ©lectionnez une date --</option>';

            if(sessions) {
                sessions.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.nom} (${s.date_debut} au ${s.date_fin})`;
                    select.appendChild(opt);
                });
            }

            select.addEventListener('change', (e) => {
                currentSessionId = e.target.value;
                if(currentSessionId) {
                    loadMapStatus();
                    document.getElementById('map-section').classList.remove('hidden');
                } else {
                    document.getElementById('map-section').classList.add('hidden');
                    document.getElementById('form-section').classList.add('hidden');
                }
            });
        }

        async function loadMapStatus() {
            const wrapper = document.getElementById('map-wrapper');
            document.querySelectorAll('.poste-marker').forEach(el => el.remove());

            const { data: resas } = await supabase
                .from('reservations')
                .select('poste_numero')
                .eq('session_id', currentSessionId);

            const taken = resas ? resas.map(r => r.poste_numero) : [];

            for(let i=1; i<=10; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'poste-marker';
                bubble.innerText = i;

                // Note: Adaptation aux noms de colonnes de ta base (poste_id, pos_x, pos_y)
                const config = postesCoords.find(c => c.poste_id === i);
                let left = '50%', top = '50%'; 
                if(config) {
                    left = config.pos_x + '%';
                    top = config.pos_y + '%';
                }

                bubble.style.left = left;
                bubble.style.top = top;

                if(taken.includes(i)) {
                    bubble.classList.add('occupe');
                    bubble.title = "DÃ©jÃ  rÃ©servÃ©";
                } else {
                    bubble.classList.add('libre');
                    bubble.onclick = () => selectPoste(i, bubble);
                }

                wrapper.appendChild(bubble);
            }
        }

        function selectPoste(id, element) {
            document.querySelectorAll('.selectionne').forEach(el => el.classList.remove('selectionne'));
            element.classList.add('selectionne');
            selectedPoste = id;

            document.getElementById('displayPoste').innerText = id;
            document.getElementById('form-section').classList.remove('hidden');
            // Scroll doux vers le formulaire
            document.getElementById('form-section').scrollIntoView({behavior: "smooth"});
        }

        document.getElementById('btnReserver').addEventListener('click', async () => {
            const nom = document.getElementById('nom').value;
            const email = document.getElementById('email').value;
            const tel = document.getElementById('tel').value;

            if(!nom || !email || !selectedPoste) return alert("Merci de tout remplir");

            const { error } = await supabase.from('reservations').insert({
                session_id: currentSessionId,
                poste_numero: selectedPoste,
                nom_client: nom,
                email_client: email,
                telephone_client: tel
            });

            if(error) {
                alert("Erreur : Ce poste vient d'Ãªtre pris !");
                loadMapStatus();
            } else {
                alert("âœ… RÃ©servation rÃ©ussie ! Pensez Ã  rÃ©gler les 60â‚¬.");
                location.reload();
            }
        });

        init();
    </script>
</body>
</html>
