<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - √âtang</title>

    <style>
        body { font-family: sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* Login */
        #login-screen { text-align: center; margin-top: 100px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1d4ed8; }

        /* Dashboard */
        #dashboard { display: none; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1e293b; }

        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .btn-del { background: #ef4444; padding: 5px 10px; font-size: 0.8rem; border-radius: 3px; color: white; border: none; cursor: pointer;}
        
        /* Nouveau bouton Plan */
        .btn-map { background: #db2777; width: 100%; font-size: 1.1em; margin-bottom: 20px; }
        .btn-map:hover { background: #be185d; }

        #error-log { color: red; margin-top: 20px; display: none; border: 1px solid red; padding: 10px; background: #fff0f0; }
    </style>
</head>
<body>

    <!-- √âcran de connexion -->
    <div id="login-screen">
        <h1>Administration</h1>
        <p id="status-msg" style="color:blue;">Connexion √† Supabase en cours...</p>

        <div id="login-form" style="display:none;">
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <button id="btnLogin">Entrer</button>
        </div>
        <div id="error-log"></div>
    </div>

    <!-- Tableau de bord -->
    <div id="dashboard" class="container">
        
        <!-- BOUTON VERS LE PLAN -->
        <a href="positionnement.html" target="_blank">
            <button class="btn-map">üìç Configurer le Plan (Glisser-D√©poser)</button>
        </a>

        <!-- Cr√©er Session -->
        <div class="card">
            <h2>üóìÔ∏è Cr√©er une Session</h2>
            <div class="row">
                <input type="text" id="nomSession" placeholder="Nom (ex: Session Juin)">
                <input type="date" id="dateDebut">
                <input type="date" id="dateFin">
                <button id="btnCreerSession">Ajouter</button>
            </div>
        </div>

        <!-- Bloquer un poste manuellement -->
        <div class="card">
            <h2>üîí Bloquer un poste (Manuel)</h2>
            <div class="row">
                <select id="sessionSelect"></select>
                <select id="posteSelect">
                    <!-- G√©n√©ration auto de 1 √† 24 -->
                    <script>
                        for(let i=1; i<=10; i++) document.write(`<option value="${i}">Poste ${i}</option>`);
                    </script>
                </select>
                <button id="btnBloquer">Bloquer</button>
            </div>
        </div>

        <!-- Liste des r√©servations -->
        <div class="card">
            <div class="row" style="justify-content: space-between;">
                <h2>üìã R√©servations</h2>
                <button id="btnRefresh">üîÑ Actualiser</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resaTable"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';

        let supabase;

        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            document.getElementById('status-msg').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        } catch (err) {
            document.getElementById('status-msg').innerText = "ERREUR CRITIQUE";
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerText = err.message;
        }

        document.getElementById('btnLogin').addEventListener('click', () => {
            if(document.getElementById('passwordInput').value === "Souffcarpe1664") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadSessions();
                loadReservations();
            } else { alert("Mot de passe incorrect"); }
        });

        document.getElementById('btnCreerSession').addEventListener('click', async () => {
            const nom = document.getElementById('nomSession').value;
            const debut = document.getElementById('dateDebut').value;
            const fin = document.getElementById('dateFin').value;
            if(!nom || !debut || !fin) return alert("Tout remplir svp");
            const { error } = await supabase.from('sessions').insert({ nom, date_debut: debut, date_fin: fin, active: true });
            if(error) alert("Erreur: " + error.message);
            else { alert("Session cr√©√©e !"); loadSessions(); }
        });

        async function loadSessions() {
            const { data } = await supabase.from('sessions').select('*').order('date_debut', { ascending: true });
            const select = document.getElementById('sessionSelect');
            select.innerHTML = '';
            if(data) data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.innerText = s.nom;
                select.appendChild(opt);
            });
        }

        async function loadReservations() {
            const { data } = await supabase.from('reservations').select('id, poste_numero, nom_client, sessions(nom)').order('created_at', { ascending: false });
            const tbody = document.getElementById('resaTable');
            tbody.innerHTML = '';
            if(data) data.forEach(r => {
                tbody.innerHTML += `<tr><td>${r.sessions?.nom}</td><td>Poste ${r.poste_numero}</td><td>${r.nom_client}</td><td><button class="btn-del" onclick="window.delResa('${r.id}')">X</button></td></tr>`;
            });
        }
        
        // Fonction globale pour le onclick du HTML
        window.delResa = async (id) => {
            if(confirm("Supprimer ?")) {
                await supabase.from('reservations').delete().eq('id', id);
                loadReservations();
            }
        };

        document.getElementById('btnRefresh').addEventListener('click', loadReservations);

        document.getElementById('btnBloquer').addEventListener('click', async () => {
            const sId = document.getElementById('sessionSelect').value;
            const pId = document.getElementById('posteSelect').value;
            if(!sId) return alert("Pas de session");
            const { error } = await supabase.from('reservations').insert({
                session_id: sId, poste_numero: pId, nom_client: "BLOQU√â ADMIN", email_client: "admin", telephone_client: "0000", paypal_order_id: "MANUEL"
            });
            if(!error) { alert("Poste bloqu√© !"); loadReservations(); }
            else alert("Erreur (d√©j√† pris ?)");
        });
    </script>
</body>
</html>

