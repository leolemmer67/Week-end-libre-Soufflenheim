<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - √âtang & Carte</title>
    
    <!-- IMPORTANT : Cette ligne emp√™che les blocages de s√©curit√© -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        
        /* LOGIN */
        #login-overlay { position: fixed; inset: 0; background: #1e293b; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #admin-content { display: none; max-width: 1000px; margin: auto; }

        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-top: 0; color: #334155; }
        
        /* INPUTS & BUTTONS */
        .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; flex: 1; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        button:hover { opacity: 0.9; }

        .btn-blue { background: #3b82f6; }
        .btn-green { background: #10b981; }
        .btn-red { background: #ef4444; }
        .btn-orange { background: #f59e0b; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        
        /* --- CARTE INTERACTIVE --- */
        #map-container {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #a5f3fc; /* Couleur eau par d√©faut */
            background-image: url('https://images.unsplash.com/photo-1547623641-82fbb83b169e?q=80&w=1000&auto=format&fit=crop'); /* Image Exemple */
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            border: 4px solid #334155;
            overflow: hidden;
            margin-top: 20px;
        }

        .poste-marker {
            position: absolute;
            width: 35px;
            height: 35px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: grab;
            user-select: none;
            box-shadow: 0 3px 5px rgba(0,0,0,0.5);
            border: 2px solid white;
            z-index: 10;
        }
        .poste-marker:active { cursor: grabbing; background: #dc2626; transform: scale(1.1); }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <h1>üîê Acc√®s Admin</h1>
        <input type="password" id="pass-input" placeholder="Mot de passe" style="width: 200px; text-align: center; color: black;">
        <br>
        <button class="btn-blue" onclick="checkPass()">Entrer</button>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <div id="admin-content">
        <h1>‚öôÔ∏è Panneau de Contr√¥le</h1>

        <!-- 1. GESTION CARTE -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üó∫Ô∏è 1. Plan de l'√©tang (Glisser-D√©poser)</h2>
                <button class="btn-green" onclick="saveMapPositions()">üíæ Enregistrer les positions</button>
            </div>
            <p>D√©placez les bulles rouges (Postes 1 √† 24) sur la carte ci-dessous.</p>
            
            <div id="map-container">
                <!-- Les postes seront g√©n√©r√©s ici par JS -->
            </div>
        </div>

        <!-- 2. CREER SESSION -->
        <div class="card">
            <h2>üìÖ 2. Cr√©er une Session</h2>
            <div class="row">
                <input type="text" id="sess-nom" placeholder="Nom (ex: Session Avril)">
                <input type="date" id="sess-debut">
                <input type="date" id="sess-fin">
                <button class="btn-blue" onclick="createSession()">Ajouter</button>
            </div>
        </div>

        <!-- 3. BLOQUER POSTE -->
        <div class="card">
            <h2>üö´ 3. Bloquer un Poste</h2>
            <div class="row">
                <select id="select-session"><option>Chargement...</option></select>
                <input type="number" id="block-id" placeholder="N¬∞ Poste" min="1" max="24">
                <button class="btn-orange" onclick="blockPoste()">Bloquer</button>
            </div>
        </div>

        <!-- 4. RESERVATIONS -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h2>üìã 4. R√©servations</h2>
                <button class="btn-blue" onclick="loadResas()">Actualiser</button>
            </div>
            <table id="resa-table">
                <thead><tr><th>Session</th><th>Poste</th><th>Client</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. CONNEXION SUPABASE (CORRIG√âE AVEC HTTPS) ---
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg3NTU2NzQsImV4cCI6MjA1NDMzMTY3NH0.U8-WkIET9M_T6wlO1w6rqWvXGv7HXm1s8nF0sM4jW14';
        
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. AUTHENTIFICATION ---
        function checkPass() {
            const p = document.getElementById('pass-input').value;
            if(p === 'Souffcarpe1664' || p === '1234') { // J'ai laiss√© 1234 pour tes tests
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                initApp();
            } else {
                alert("Mot de passe incorrect");
            }
        }

        async function initApp() {
            console.log("App D√©marr√©e");
            loadMapPositions(); // Charge la carte
            loadSessions();     // Charge le menu d√©roulant
            loadResas();        // Charge le tableau
        }

        // --- 3. LOGIQUE DE LA CARTE (DRAG & DROP) ---
        const mapContainer = document.getElementById('map-container');
        let postesPositions = []; // Stocke les positions

        // Fonction pour initialiser les 24 postes sur la carte
        async function loadMapPositions() {
            // 1. R√©cup√©rer les positions sauvegard√©es
            const { data, error } = await client.from('postes_config').select('*');
            
            mapContainer.innerHTML = ''; // Vider la carte

            for (let i = 1; i <= 24; i++) {
                const el = document.createElement('div');
                el.className = 'poste-marker';
                el.textContent = i;
                el.id = 'poste-' + i;
                
                // Position par d√©faut ou charg√©e depuis Supabase
                let top = '10%'; 
                let left = (i * 3) + '%'; // D√©cal√©s un peu par d√©faut

                if (data && data.length > 0) {
                    const saved = data.find(p => p.poste_id === i);
                    if (saved) {
                        left = saved.pos_x + '%';
                        top = saved.pos_y + '%';
                    }
                }

                el.style.left = left;
                el.style.top = top;

                // Ajout de l'√©v√©nement Drag
                dragElement(el);
                mapContainer.appendChild(el);
            }
        }

        // Logique de glissement (Drag) simple
        function dragElement(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // Calcul du d√©placement
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Appliquer nouvelle position en pixels
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Sauvegarder les positions dans Supabase
        async function saveMapPositions() {
            const updates = [];
            const containerRect = mapContainer.getBoundingClientRect();

            for (let i = 1; i <= 24; i++) {
                const el = document.getElementById('poste-' + i);
                
                // Calculer la position en Pourcentage (%) pour que √ßa reste responsive
                // (Position du point / Largeur du conteneur) * 100
                const xPercent = (el.offsetLeft / containerRect.width) * 100;
                const yPercent = (el.offsetTop / containerRect.height) * 100;

                updates.push({
                    poste_id: i,
                    pos_x: xPercent,
                    pos_y: yPercent
                });
            }

            // Upsert (Ins√©rer ou Mettre √† jour)
            const { error } = await client.from('postes_config').upsert(updates);

            if (error) {
                alert("Erreur Sauvegarde Plan : " + error.message + "\n(Avez-vous cr√©√© la table postes_config ?)");
            } else {
                alert("‚úÖ Plan de l'√©tang enregistr√© avec succ√®s !");
            }
        }


        // --- 4. GESTION DES DONN√âES (SESSIONS / RESA) ---
        
        // Charger Sessions dans le Select
        async function loadSessions() {
            const { data } = await client.from('sessions').select('*').order('date_debut');
            const sel = document.getElementById('select-session');
            sel.innerHTML = '<option value="">-- Choisir Session --</option>';
            if(data) {
                data.forEach(s => {
                    sel.innerHTML += `<option value="${s.id}">${s.nom}</option>`;
                });
            }
        }

        // Cr√©er Session
        async function createSession() {
            const nom = document.getElementById('sess-nom').value;
            const deb = document.getElementById('sess-debut').value;
            const fin = document.getElementById('sess-fin').value;
            
            if(!nom || !deb) return alert("Remplir les champs");
            
            const { error } = await client.from('sessions').insert([{ nom, date_debut: deb, date_fin: fin }]);
            if(error) alert(error.message);
            else { alert("Session Cr√©√©e"); loadSessions(); }
        }

        // Bloquer Poste
        async function blockPoste() {
            const sid = document.getElementById('select-session').value;
            const pid = document.getElementById('block-id').value;
            
            if(!sid || !pid) return alert("Choisir session et poste");

            const { error } = await client.from('reservations').insert([{
                session_id: sid,
                poste_id: pid,
                client_nom: '‚õî BLOQU√â',
                client_email: 'admin',
                client_tel: '000'
            }]);

            if(error) alert("Erreur (d√©j√† pris ?) : " + error.message);
            else { alert("Poste Bloqu√©"); loadResas(); }
        }

        // Charger R√©servations
        async function loadResas() {
            const tbody = document.querySelector('#resa-table tbody');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';
            
            const { data, error } = await client.from('reservations')
                .select('id, poste_id, client_nom, sessions(nom)')
                .order('id', {ascending: false});
            
            if(error) {
                tbody.innerHTML = `<tr><td colspan="4" style="color:red">${error.message}</td></tr>`;
                return;
            }

            tbody.innerHTML = '';
            data.forEach(r => {
                const sNom = r.sessions ? r.sessions.nom : '???';
                tbody.innerHTML += `
                    <tr>
                        <td>${sNom}</td>
                        <td>${r.poste_id}</td>
                        <td>${r.client_nom}</td>
                        <td><button class="btn-red" onclick="delResa(${r.id})">X</button></td>
                    </tr>
                `;
            });
        }

        async function delResa(id) {
            if(confirm("Supprimer ?")) {
                await client.from('reservations').delete().eq('id', id);
                loadResas();
            }
        }

    </script>
</body>
</html>
