<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üëá C'est LUI qui autorise la connexion (CSP) üëá -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *;">

    <title>Administration - √âtang</title>
    
    <!-- Chargement de Supabase via un CDN fiable -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f9; }
        
        /* √âcran de connexion */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; }
        #admin-panel { display: none; } /* Cach√© par d√©faut */

        h1, h2 { text-align: center; color: #333; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ddd; }
        button { background-color: #2563eb; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #1d4ed8; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        .btn-danger { background-color: #dc2626; }
        .btn-config { background-color: #db2777; width: 100%; display: block; text-align: center; text-decoration: none; padding: 15px; border-radius: 8px; color: white; font-size: 16px; margin-bottom: 20px; }
        
        /* Status Indicator */
        #status-indicator { text-align: center; padding: 10px; font-weight: bold; margin-bottom: 10px; border-radius: 4px; }
        .status-ok { background-color: #dcfce7; color: #166534; border: 1px solid #166534; }
        .status-err { background-color: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
    </style>
</head>
<body>

    <!-- 1. √âCRAN DE CONNEXION -->
    <div id="login-screen">
        <h2>üîí Acc√®s R√©serv√©</h2>
        <input type="password" id="admin-password" placeholder="Mot de passe">
        <button onclick="checkPassword()">Entrer</button>
        <p id="login-error" style="color: red; display: none;">Mot de passe incorrect</p>
    </div>

    <!-- 2. PANNEAU ADMIN (Cach√© au d√©but) -->
    <div id="admin-panel">
        
        <h1>Panneau de contr√¥le</h1>
        
        <!-- Indicateur de connexion -->
        <div id="status-indicator" class="status-err">‚ö™ Tentative de connexion √† Supabase...</div>

        <a href="positionnement.html" class="btn-config">üìç Modifier le plan de l'√©tang (Glisser-D√©poser)</a>

        <!-- Cr√©er Session -->
        <div class="card">
            <h2>üóìÔ∏è Cr√©er une Session</h2>
            <input type="text" id="sessionName" placeholder="Nom (ex: Session juin)">
            <input type="date" id="startDate">
            <input type="date" id="endDate">
            <button onclick="createSession()">Ajouter</button>
        </div>

        <!-- Liste R√©servations -->
        <div class="card">
            <h2>üìã R√©servations <button onclick="loadReservations()" style="float:right; font-size:12px; padding:5px;">Actualiser</button></h2>
            <table>
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resa-list">
                    <tr><td colspan="4">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // J'ai reconstitu√© l'URL compl√®te d'apr√®s tes captures d'√©cran
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg3NDg0NDMsImV4cCI6MjA1NDMyNDQ0M30.S7k5fR2UqT4-J6lM4oVgwC1oZ8nNDGGeC90Jc5b8O50';
        let client;

        // --- 1. GESTION DU MOT DE PASSE ---
        function checkPassword() {
            const pass = document.getElementById('admin-password').value;
            // Remplace '1234' par ton vrai mot de passe
            if (pass === '1234') { 
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                initSupabase(); // On lance la connexion seulement apr√®s le login
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        // --- 2. INITIALISATION SUPABASE ---
        function initSupabase() {
            try {
                // V√©rification basique que la librairie est charg√©e
                if (typeof supabase === 'undefined') {
                    throw new Error("La librairie Supabase n'est pas charg√©e. V√©rifiez votre connexion internet.");
                }

                client = supabase.createClient(supabaseUrl, supabaseKey);
                
                // Test de connexion simple
                console.log("Supabase initialis√©, test de connexion...");
                document.getElementById('status-indicator').innerText = "üü† Connexion en cours...";
                
                loadReservations(); // Lance le chargement des donn√©es

            } catch (e) {
                console.error("Erreur Critique:", e);
                setStatus("‚ùå Erreur: " + e.message, false);
            }
        }

        function setStatus(msg, isSuccess) {
            const el = document.getElementById('status-indicator');
            el.innerText = msg;
            el.className = isSuccess ? 'status-ok' : 'status-err';
        }

        // --- 3. FONCTIONS ADMIN ---

        async function createSession() {
            const nom = document.getElementById('sessionName').value;
            const debut = document.getElementById('startDate').value;
            const fin = document.getElementById('endDate').value;

            if(!nom || !debut || !fin) return alert("Remplissez tout !");

            const { error } = await client.from('sessions').insert([{ nom: nom, date_debut: debut, date_fin: fin }]);

            if(!error) {
                alert("Session cr√©√©e !");
                loadReservations(); 
            } else {
                alert("Erreur: " + error.message);
            }
        }

        async function loadReservations() {
            const tbody = document.getElementById('resa-list');
            
            // On r√©cup√®re les donn√©es
            const { data, error } = await client
                .from('reservations')
                .select(`id, poste_id, client_nom, sessions ( nom )`);

            if (error) {
                console.error("Erreur Load:", error);
                setStatus("‚ùå Erreur de connexion: " + error.message, false);
                tbody.innerHTML = '<tr><td colspan="4" class="error">Erreur de chargement</td></tr>';
                return;
            }

            // Si on arrive ici, c'est que la connexion marche !
            setStatus("‚úÖ Connect√© √† la base de donn√©es", true);

            tbody.innerHTML = '';
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucune r√©servation</td></tr>';
                return;
            }

            data.forEach(resa => {
                const tr = document.createElement('tr');
                const sessionNom = resa.sessions ? resa.sessions.nom : 'Inconnue';
                
                tr.innerHTML = `
                    <td>${sessionNom}</td>
                    <td>Poste ${resa.poste_id}</td>
                    <td>${resa.client_nom}</td>
                    <td><button class="btn-danger" onclick="supprimerResa(${resa.id})">X</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function supprimerResa(id) {
            if(!confirm("Supprimer cette r√©servation ?")) return;
            const { error } = await client.from('reservations').delete().eq('id', id);
            if(!error) loadReservations();
            else alert("Erreur suppression: " + error.message);
        }

    </script>
</body>
</html>
