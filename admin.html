<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- CSP TR√àS PERMISSIVE pour √©viter les blocages -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *;">

    <title>Administration - √âtang</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f9; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; }
        #admin-panel { display: none; }

        h1, h2 { text-align: center; color: #333; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ddd; }
        button { background-color: #2563eb; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #1d4ed8; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        .btn-danger { background-color: #dc2626; padding: 5px 10px; }
        
        .status-bar { padding: 10px; margin-bottom: 15px; border-radius: 5px; text-align: center; font-weight: bold; display: none;}
        .status-ok { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .status-err { background-color: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <h2>üîí Acc√®s Administrateur</h2>
        <input type="password" id="password" placeholder="Mot de passe">
        <button onclick="checkLogin()">Entrer</button>
    </div>

    <!-- PANNEAU ADMIN -->
    <div id="admin-panel">
        <h1>Panneau de contr√¥le</h1>

        <div id="connection-status" class="status-bar"></div>

        <!-- 1. Cr√©er Session -->
        <div class="card">
            <h2>üóìÔ∏è Cr√©er une Session</h2>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                <input type="text" id="session-nom" placeholder="Nom (ex: Session juin)" style="flex:1;">
                <input type="date" id="session-debut">
                <input type="date" id="session-fin">
                <button onclick="creerSession()">Ajouter</button>
            </div>
        </div>

        <!-- 2. R√©servations -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üìã R√©servations</h2>
                <button onclick="loadReservations()" style="background:#10b981;">Actualiser</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resa-list">
                    <tr><td colspan="4">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // üëá ICI C'EST LA CORRECTION IMPORTANTE üëá
        // J'ai ajout√© 'https://' au d√©but et '.supabase.co' √† la fin
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co'; 
        
        // Ta cl√© (reste la m√™me)
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg3NTU2NzQsImV4cCI6MjA1NDMzMTY3NH0.U8-WkIET9M_T6wlO1w6rqWvXGv7HXm1s8nF0sM4jW14';
        
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        function checkLogin() {
            const pass = document.getElementById('password').value;
            // Mot de passe remis √† 1234 pour tester facilement
            if (pass === '1234') { 
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadReservations(); // On charge les donn√©es d√®s la connexion
            } else {
                alert("Mot de passe incorrect");
            }
        }

        function setStatus(msg, isSuccess) {
            const el = document.getElementById('connection-status');
            el.style.display = 'block';
            el.textContent = msg;
            el.className = 'status-bar ' + (isSuccess ? 'status-ok' : 'status-err');
        }

        // 1. Cr√©er Session
        async function creerSession() {
            const nom = document.getElementById('session-nom').value;
            const debut = document.getElementById('session-debut').value;
            const fin = document.getElementById('session-fin').value;

            if(!nom || !debut || !fin) return alert("Remplissez tout !");

            const { error } = await client.from('sessions').insert([{ nom: nom, date_debut: debut, date_fin: fin }]);

            if(!error) {
                alert("Session cr√©√©e !");
                loadReservations(); 
            } else {
                alert("Erreur: " + error.message);
            }
        }

        // 2. Charger R√©servations
        async function loadReservations() {
            const tbody = document.getElementById('resa-list');
            
            // On r√©cup√®re les donn√©es
            const { data, error } = await client
                .from('reservations')
                .select(`id, poste_id, client_nom, sessions ( nom )`);

            if (error) {
                console.error("Erreur Load:", error);
                setStatus("‚ùå Erreur: " + error.message, false);
                tbody.innerHTML = '<tr><td colspan="4" class="error">Erreur de chargement</td></tr>';
                return;
            }

            setStatus("‚úÖ Connect√© √† Supabase", true);

            tbody.innerHTML = '';
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucune r√©servation</td></tr>';
                return;
            }

            data.forEach(resa => {
                const tr = document.createElement('tr');
                const sessionNom = resa.sessions ? resa.sessions.nom : 'Inconnue';
                
                tr.innerHTML = `
                    <td>${sessionNom}</td>
                    <td>Poste ${resa.poste_id}</td>
                    <td>${resa.client_nom}</td>
                    <td><button class="btn-danger" onclick="supprimerResa(${resa.id})">X</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function supprimerResa(id) {
            if(!confirm("Supprimer cette r√©servation ?")) return;
            const { error } = await client.from('reservations').delete().eq('id', id);
            if(!error) loadReservations();
            else alert("Erreur suppression: " + error.message);
        }

    </script>
</body>
</html>
