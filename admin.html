<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üõ°Ô∏è S√âCURIT√â : Version tr√®s permissive pour d√©bloquer la situation -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <title>Administration - √âtang</title>
    
    <!-- Supabase SDK via jsDelivr (plus stable) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Login */
        #login-screen { text-align: center; margin-top: 100px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1d4ed8; }

        /* Dashboard */
        #dashboard { display: none; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1e293b; }
        
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .btn-del { background: #ef4444; padding: 5px 10px; font-size: 0.8rem; border-radius: 3px; color: white; border: none; cursor: pointer;}
    </style>
</head>
<body>

    <!-- √âcran de connexion -->
    <div id="login-screen">
        <h1>Administration</h1>
        <p id="status-msg" style="color:gray; font-size: 0.9rem;">Chargement du syst√®me...</p>
        <div id="login-form" style="display:none;">
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <button onclick="checkLogin()">Entrer</button>
        </div>
    </div>

    <!-- Tableau de bord -->
    <div id="dashboard" class="container">
        
        <!-- Cr√©er Session -->
        <div class="card">
            <h2>üóìÔ∏è Cr√©er une Session</h2>
            <div class="row">
                <input type="text" id="nomSession" placeholder="Nom (ex: Session Juin)">
                <input type="date" id="dateDebut">
                <input type="date" id="dateFin">
                <button onclick="creerSession()">Ajouter</button>
            </div>
        </div>

        <!-- Bloquer un poste manuellement -->
        <div class="card">
            <h2>üîí Bloquer un poste (Manuel)</h2>
            <div class="row">
                <select id="sessionSelect"></select>
                <select id="posteSelect">
                    <option value="1">Poste 1</option>
                    <option value="2">Poste 2</option>
                    <option value="3">Poste 3</option>
                    <option value="4">Poste 4</option>
                    <option value="5">Poste 5</option>
                    <option value="6">Poste 6</option>
                    <option value="7">Poste 7</option>
                    <option value="8">Poste 8</option>
                    <option value="9">Poste 9</option>
                    <option value="10">Poste 10</option>
                    <option value="11">Poste 11</option>
                    <option value="12">Poste 12</option>
                </select>
                <button onclick="bloquerPoste()">Bloquer</button>
            </div>
        </div>

        <!-- Liste des r√©servations -->
        <div class="card">
            <div class="row" style="justify-content: space-between;">
                <h2>üìã R√©servations</h2>
                <button onclick="loadReservations()">üîÑ Actualiser</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resaTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://drhsdlzhxkbamwcskblr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g';
        
        let supabase;

        // On attend que la page soit 100% charg√©e pour initialiser
        window.onload = function() {
            if (window.supabase) {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log("Supabase OK");
                    document.getElementById('status-msg').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                } catch (err) {
                    alert("Erreur interne Supabase : " + err.message);
                }
            } else {
                document.getElementById('status-msg').innerText = "Erreur : Impossible de charger la librairie Supabase.";
                document.getElementById('status-msg').style.color = "red";
            }
        };

        function checkLogin() {
            const pass = document.getElementById('passwordInput').value;
            if(pass === "Souffcarpe1664") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadSessions();
                loadReservations();
            } else {
                alert("Mot de passe incorrect");
            }
        }

        async function creerSession() {
            const nom = document.getElementById('nomSession').value;
            const debut = document.getElementById('dateDebut').value;
            const fin = document.getElementById('dateFin').value;

            if(!nom || !debut || !fin) return alert("Remplissez tous les champs !");

            const { error } = await supabase.from('sessions').insert({
                nom: nom,
                date_debut: debut,
                date_fin: fin,
                active: true
            });

            if(error) {
                console.error(error);
                alert("Erreur cr√©ation session : " + error.message);
            } else {
                alert("Session cr√©√©e !");
                loadSessions();
                document.getElementById('nomSession').value = '';
            }
        }

        async function loadSessions() {
            const { data, error } = await supabase.from('sessions').select('*').order('date_debut', { ascending: true });
            
            if (error) { console.error(error); return; }

            const select = document.getElementById('sessionSelect');
            select.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.innerText = `${s.nom} (${s.date_debut})`;
                    select.appendChild(opt);
                });
            } else {
                select.innerHTML = '<option>Aucune session</option>';
            }
        }

        async function loadReservations() {
            const { data, error } = await supabase
                .from('reservations')
                .select('id, poste_numero, nom_client, email_client, sessions(nom)')
                .order('created_at', { ascending: false });

            if (error) { console.error(error); return; }

            const tbody = document.getElementById('resaTable');
            tbody.innerHTML = '';

            if(data) {
                data.forEach(r => {
                    const sessionName = r.sessions ? r.sessions.nom : 'Inconnue';
                    const row = `<tr>
                        <td>${sessionName}</td>
                        <td>Poste ${r.poste_numero}</td>
                        <td>${r.nom_client}<br><small>${r.email_client}</small></td>
                        <td><button class="btn-del" onclick="supprimerResa(${r.id})">Supprimer</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        }

        async function bloquerPoste() {
            const sessionId = document.getElementById('sessionSelect').value;
            const posteId = document.getElementById('posteSelect').value;
            
            if (!sessionId || isNaN(sessionId)) return alert("S√©lectionnez une session valide.");

            const { error } = await supabase.from('reservations').insert({
                session_id: sessionId,
                poste_numero: posteId,
                nom_client: "‚õî BLOQU√â ADMIN",
                email_client: "admin@etang.fr",
                telephone_client: "0000000000",
                paypal_order_id: "MANUEL_ADMIN"
            });

            if(!error) {
                alert(`Poste ${posteId} bloqu√©.`);
                loadReservations();
            } else {
                alert("Erreur : Ce poste est d√©j√† pris.");
            }
        }

        async function supprimerResa(id) {
            if(confirm("Supprimer cette r√©servation ?")) {
                const { error } = await supabase.from('reservations').delete().eq('id', id);
                if (!error) loadReservations();
            }
        }
    </script>
</body>
</html>
