<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - √âtang de la Carpe</title>
    
    <!-- Autorise la connexion √† Supabase -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline';">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f0f2f5; }
        
        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; }
        #admin-panel { display: none; }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 5px; }
        
        .btn-add { background-color: #2563eb; color: white; }
        .btn-block { background-color: #d97706; color: white; }
        .btn-del { background-color: #dc2626; color: white; width: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        tr:hover { background-color: #f9f9f9; }

        .row { display: flex; gap: 10px; }
        .row input, .row select { flex: 1; }
    </style>
</head>
<body>

    <!-- 1. √âCRAN DE CONNEXION -->
    <div id="login-screen">
        <h2>üîí Administration</h2>
        <input type="password" id="password" placeholder="Mot de passe" style="width: 200px; text-align: center;">
        <button onclick="checkLogin()" style="width: 200px; margin-top: 10px;">Entrer</button>
    </div>

    <!-- 2. PANNEAU ADMIN -->
    <div id="admin-panel">
        <h1>Panneau de Contr√¥le</h1>
        
        <!-- Bloc 1 : Cr√©er Session -->
        <div class="card">
            <h2>üóìÔ∏è 1. Cr√©er une Session</h2>
            <div class="row">
                <input type="text" id="sess-nom" placeholder="Nom (ex: Mars 2024)">
                <input type="date" id="sess-debut">
                <input type="date" id="sess-fin">
            </div>
            <button class="btn-add" onclick="creerSession()">Ajouter la Session</button>
        </div>

        <!-- Bloc 2 : Bloquer un Poste -->
        <div class="card">
            <h2>üö´ 2. Bloquer un Poste (Maintenance/Admin)</h2>
            <p style="font-size:0.9em; color:#666;">S√©lectionnez une session existante et le num√©ro du poste √† bloquer.</p>
            <div class="row">
                <select id="block-session-select">
                    <option value="">Chargement des sessions...</option>
                </select>
                <input type="number" id="block-poste" placeholder="N¬∞ Poste (1-24)" min="1" max="24">
            </div>
            <button class="btn-block" onclick="bloquerPoste()">Bloquer ce poste</button>
        </div>

        <!-- Bloc 3 : Liste des R√©servations -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üìã 3. Liste des R√©servations</h2>
                <button onclick="loadReservations()" style="width:auto; background:#10b981; color:white;">Actualiser</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resa-list">
                    <!-- Rempli par JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURATION CORRIG√âE ---
        // C'est ici que c'√©tait cass√© avant (il manquait https:// et .supabase.co)
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg3NTU2NzQsImV4cCI6MjA1NDMzMTY3NH0.U8-WkIET9M_T6wlO1w6rqWvXGv7HXm1s8nF0sM4jW14';
        
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        // --- CONNEXION ---
        function checkLogin() {
            const pass = document.getElementById('password').value;
            // J'ai remis ton mot de passe d'origine
            if (pass === 'Souffcarpe1664') { 
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                initData(); // Charge les donn√©es
            } else {
                alert("Mot de passe incorrect");
            }
        }

        async function initData() {
            loadReservations();
            loadSessionsForSelect();
        }

        // --- 1. CR√âER SESSION ---
        async function creerSession() {
            const nom = document.getElementById('sess-nom').value;
            const deb = document.getElementById('sess-debut').value;
            const fin = document.getElementById('sess-fin').value;

            if(!nom || !deb || !fin) return alert("Tout remplir svp");

            const { error } = await client.from('sessions').insert([{ nom: nom, date_debut: deb, date_fin: fin }]);
            
            if(error) alert("Erreur: " + error.message);
            else {
                alert("‚úÖ Session cr√©√©e !");
                loadSessionsForSelect(); // Met √† jour la liste d√©roulante
            }
        }

        // --- 2. BLOQUER POSTE ---
        // Charge la liste des sessions dans le menu d√©roulant
        async function loadSessionsForSelect() {
            const { data, error } = await client.from('sessions').select('*').order('date_debut');
            const select = document.getElementById('block-session-select');
            
            if(error) return console.error(error);
            
            select.innerHTML = '<option value="">-- Choisir une session --</option>';
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.nom} (${s.date_debut})`;
                select.appendChild(opt);
            });
        }

        async function bloquerPoste() {
            const sessionId = document.getElementById('block-session-select').value;
            const posteId = document.getElementById('block-poste').value;

            if(!sessionId || !posteId) return alert("Choisir une session et un poste");

            // On cr√©e une r√©servation au nom de "ADMIN"
            const { error } = await client.from('reservations').insert([
                { 
                    session_id: sessionId, 
                    poste_id: posteId, 
                    client_nom: '‚õî POSTE BLOQU√â', 
                    client_email: 'admin@etang.fr',
                    client_tel: '0000000000'
                }
            ]);

            if(error) alert("Erreur (poste d√©j√† pris ?): " + error.message);
            else {
                alert("‚úÖ Poste bloqu√©.");
                loadReservations();
            }
        }

        // --- 3. LISTE RESERVATIONS ---
        async function loadReservations() {
            const tbody = document.getElementById('resa-list');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';

            const { data, error } = await client
                .from('reservations')
                .select('id, poste_id, client_nom, sessions(nom)')
                .order('id', { ascending: false });

            if(error) {
                tbody.innerHTML = '<tr><td colspan="4" style="color:red">Erreur connexion</td></tr>';
                return alert(error.message);
            }

            tbody.innerHTML = '';
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucune r√©servation</td></tr>';
                return;
            }

            data.forEach(r => {
                const tr = document.createElement('tr');
                // Gestion du cas o√π la session a √©t√© supprim√©e mais pas la r√©sa
                const sessionNom = r.sessions ? r.sessions.nom : 'Session supprim√©e';
                
                tr.innerHTML = `
                    <td>${sessionNom}</td>
                    <td><strong>${r.poste_id}</strong></td>
                    <td>${r.client_nom}</td>
                    <td><button class="btn-del" onclick="supprimer(${r.id})">X</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function supprimer(id) {
            if(confirm("Supprimer cette r√©servation / blocage ?")) {
                const { error } = await client.from('reservations').delete().eq('id', id);
                if(!error) loadReservations();
                else alert(error.message);
            }
        }
    </script>
</body>
</html>
