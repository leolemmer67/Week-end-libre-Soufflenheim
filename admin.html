<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üü¢ CETTE LIGNE AUTORISE TOUT (Pour √©viter les erreurs rouges) -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <title>Administration - √âtang</title>
    
    <style>
        body { font-family: sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Login */
        #login-screen { text-align: center; margin-top: 100px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1d4ed8; }

        /* Dashboard */
        #dashboard { display: none; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1e293b; }
        
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .btn-del { background: #ef4444; padding: 5px 10px; font-size: 0.8rem; border-radius: 3px; color: white; border: none; cursor: pointer;}
    </style>
</head>
<body>

    <!-- √âcran de connexion -->
    <div id="login-screen">
        <h1>Administration</h1>
        <p id="status-msg" style="color:blue;">Connexion syst√®me...</p>
        
        <div id="login-form" style="display:none;">
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <button onclick="checkPassword()">Entrer</button>
        </div>
    </div>

    <!-- Tableau de bord -->
    <div id="dashboard" class="container">
        <h1>Panneau de contr√¥le</h1>

        <!-- 1. Cr√©er Session -->
        <div class="card">
            <h2>üìÖ Cr√©er une Session</h2>
            <div class="row">
                <input type="text" id="sessionName" placeholder="Nom (ex: Session juin)">
                <input type="date" id="sessionStart">
                <input type="date" id="sessionEnd">
                <button onclick="createSession()">Ajouter</button>
            </div>
        </div>
        
    <div style="margin-bottom: 20px;">
    <a href="positionnement.html" target="_blank" style="background: #e11d48; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">
        üìç Modifier le plan de l'√©tang (Glisser-D√©poser)
    </a>
</div>

        <!-- 2. Bloquer Poste -->
        <div class="card">
            <h2>üîí Bloquer un poste (Manuel)</h2>
            <div class="row">
                <select id="sessionSelect"></select>
                <select id="posteSelect">
                    <option value="1">Poste 1</option>
                    <option value="2">Poste 2</option>
                    <option value="3">Poste 3</option>
                    <option value="4">Poste 4</option>
                    <option value="5">Poste 5</option>
                    <option value="6">Poste 6</option>
                    <option value="7">Poste 7</option>
                </select>
                <button id="btnBloquer" style="background:#4f46e5;">Bloquer</button>
            </div>
        </div>

        <!-- 3. Liste R√©servations -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h2>üìã R√©servations</h2>
                <button id="btnRefresh" style="background:#10b981;">Actualiser</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resa-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Script Module (Moderne) -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://drhsdlrxhkbamwcskblr.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1ODcyMjYsImV4cCI6MjA1NDE2MzIyNn0.S5v0-u1VvLGe_3iS-bTbQrnT9p0k9ZkwG-iS_Wiw7pQ'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)
        const ADMIN_PASS = "Souffcarpe1664"

        // Rendre les fonctions accessibles globalement
        window.checkPassword = checkPassword;
        window.createSession = createSession;

        // Initialisation
        window.onload = () => {
            console.log("Supabase initialis√© !");
            document.getElementById('status-msg').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        };

        // 1. Login Simple
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if(input === ADMIN_PASS) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadSessions();
                loadReservations();
            } else {
                alert("Mot de passe incorrect");
            }
        }

        // 2. Charger les sessions (pour le menu d√©roulant)
        async function loadSessions() {
            const { data, error } = await supabase.from('sessions').select('*').order('created_at', { ascending: false });
            if(error) console.error("Erreur sessions:", error);
            
            const select = document.getElementById('sessionSelect');
            select.innerHTML = '';
            if(data) {
                data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.nom} (${new Date(s.date_debut).toLocaleDateString()})`;
                    select.appendChild(opt);
                });
            }
        }

        // 3. Cr√©er Session
        async function createSession() {
            const nom = document.getElementById('sessionName').value;
            const debut = document.getElementById('sessionStart').value;
            const fin = document.getElementById('sessionEnd').value;

            if(!nom || !debut || !fin) return alert("Remplissez tout !");

            const { error } = await supabase.from('sessions').insert({ nom, date_debut: debut, date_fin: fin });

            if(!error) {
                alert("Session cr√©√©e !");
                loadSessions();
            } else {
                console.error(error);
                alert("Erreur cr√©ation session");
            }
        }

        // 4. Charger R√©servations
        async function loadReservations() {
            const tbody = document.getElementById('resa-list');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';

            const { data, error } = await supabase
                .from('reservations')
                .select(`
                    id, 
                    poste_numero, 
                    nom_client, 
                    sessions ( nom )
                `)
                .order('id', { ascending: false });

            tbody.innerHTML = '';

            if(error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="4" style="color:red">Erreur chargement</td></tr>';
            } else {
                data.forEach(r => {
                    const sName = r.sessions ? r.sessions.nom : '??';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${sName}</td>
                        <td>Poste ${r.poste_numero}</td>
                        <td>${r.nom_client}</td>
                        <td><button class="btn-del" data-id="${r.id}">X</button></td>
                    `;
                    tbody.appendChild(tr);
                });

                // Attacher les √©v√©nements suppression
                document.querySelectorAll('.btn-del').forEach(btn => {
                    btn.addEventListener('click', (e) => supprimerResa(e.target.dataset.id));
                });
            }
        }
        
        // 5. Bouton Refresh
        document.getElementById('btnRefresh').addEventListener('click', loadReservations);

        // 6. Bloquer Poste
        document.getElementById('btnBloquer').addEventListener('click', async () => {
            const sId = document.getElementById('sessionSelect').value;
            const pId = document.getElementById('posteSelect').value;

            if(!sId) return alert("Pas de session s√©lectionn√©e");

            const { error } = await supabase.from('reservations').insert({
                session_id: sId,
                poste_numero: pId,
                nom_client: "BLOQU√â ADMIN",
                email_client: "admin@etang.fr",
                telephone_client: "0000",
                paypal_order_id: "MANUEL"
            });

            if(!error) { alert("Poste bloqu√© !"); loadReservations(); }
            else alert("Erreur (Poste d√©j√† pris ?)");
        });

        // 7. Supprimer
        async function supprimerResa(id) {
            if(confirm("Supprimer cette r√©servation ? Le poste sera lib√©r√©.")) {
                await supabase.from('reservations').delete().eq('id', id);
                loadReservations();
            }
        }

    </script>
</body>
</html>

