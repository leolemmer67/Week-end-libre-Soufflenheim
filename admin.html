<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - √âtang</title>
    
    <!-- Ligne de s√©curit√© obligatoire -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f0f2f5; }
        
        /* Bouton Plan */
        .btn-map {
            display: block; width: 100%; padding: 20px;
            background: #db2777; color: white; text-align: center;
            text-decoration: none; font-size: 1.2em; font-weight: bold;
            border-radius: 8px; margin-bottom: 30px; box-shadow: 0 4px 0 #9d174d;
        }
        .btn-map:hover { background: #be185d; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; }
        #admin-panel { display: none; }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;}
        button { cursor: pointer; font-weight: bold; border: none; color: white; }
        
        .btn-add { background-color: #2563eb; }
        .btn-block { background-color: #d97706; }
        .btn-del { background-color: #dc2626; width: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <h2>üîí Administration</h2>
        <input type="password" id="password" placeholder="Mot de passe" style="width: 200px; text-align: center;">
        <button onclick="login()" style="width: 200px; background: #2563eb;">Entrer</button>
    </div>

    <!-- PANNEAU ADMIN -->
    <div id="admin-panel">
        
        <!-- LE BOUTON VERS LA PAGE DE POSITIONNEMENT -->
        <a href="positionnement.html" class="btn-map">üìç Modifier le plan de l'√©tang (Glisser-D√©poser)</a>

        <!-- 1. CREER SESSION -->
        <div class="card">
            <h2>üìÖ 1. Cr√©er une Session</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="sess-nom" placeholder="Nom (ex: Session Avril)">
                <input type="date" id="sess-debut">
                <input type="date" id="sess-fin">
            </div>
            <button class="btn-add" onclick="createSession()">Ajouter la Session</button>
        </div>

        <!-- 2. BLOQUER POSTE -->
        <div class="card">
            <h2>üö´ 2. Bloquer un Poste</h2>
            <div style="display:flex; gap:10px;">
                <select id="select-session"><option>Chargement...</option></select>
                <input type="number" id="block-id" placeholder="N¬∞ Poste" min="1" max="24">
            </div>
            <button class="btn-block" onclick="blockPoste()">Bloquer ce poste</button>
        </div>

        <!-- 3. LISTE -->
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h2>üìã 3. Liste des R√©servations</h2>
                <button onclick="loadResas()" style="width:auto; background:#10b981;">Actualiser</button>
            </div>
            <table id="resa-table">
                <thead><tr><th>Session</th><th>Poste</th><th>Client</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // ADRESSE CORRIG√âE (HTTPS)
        const supabaseUrl = 'https://drhsdlrxhkbamwcskblr.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHJ4aGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg3NTU2NzQsImV4cCI6MjA1NDMzMTY3NH0.U8-WkIET9M_T6wlO1w6rqWvXGv7HXm1s8nF0sM4jW14';
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        function login() {
            if(document.getElementById('password').value === 'Souffcarpe1664') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadSessions();
                loadResas();
            } else { alert("Mot de passe incorrect"); }
        }

        async function loadSessions() {
            const { data } = await client.from('sessions').select('*').order('date_debut');
            const sel = document.getElementById('select-session');
            sel.innerHTML = '<option value="">-- Choisir Session --</option>';
            if(data) data.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.nom}</option>`);
        }

        async function createSession() {
            const nom = document.getElementById('sess-nom').value;
            const deb = document.getElementById('sess-debut').value;
            const fin = document.getElementById('sess-fin').value;
            if(!nom) return alert("Nom manquant");
            const { error } = await client.from('sessions').insert([{ nom, date_debut: deb, date_fin: fin }]);
            if(error) alert(error.message);
            else { alert("Session cr√©√©e"); loadSessions(); }
        }

        async function blockPoste() {
            const sid = document.getElementById('select-session').value;
            const pid = document.getElementById('block-id').value;
            if(!sid || !pid) return alert("Info manquante");

            const { error } = await client.from('reservations').insert([{
                session_id: sid, poste_id: pid,
                client_nom: '‚õî MAINTANCE', client_email: 'admin', client_tel: '0'
            }]);
            if(error) alert("Erreur: " + error.message);
            else { alert("Bloqu√© !"); loadResas(); }
        }

        async function loadResas() {
            const tbody = document.querySelector('#resa-table tbody');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';
            const { data, error } = await client.from('reservations').select('id, poste_id, client_nom, sessions(nom)').order('id', {ascending:false});
            
            if(error) return tbody.innerHTML = '<tr><td colspan="4" style="color:red">Erreur connexion</td></tr>';
            tbody.innerHTML = '';
            data.forEach(r => {
                const sname = r.sessions ? r.sessions.nom : '?';
                tbody.innerHTML += `<tr><td>${sname}</td><td>${r.poste_id}</td><td>${r.client_nom}</td><td><button class="btn-del" onclick="del(${r.id})">X</button></td></tr>`;
            });
        }
        async function del(id) {
            if(confirm("Supprimer ?")) { await client.from('reservations').delete().eq('id', id); loadResas(); }
        }
    </script>
</body>
</html>
