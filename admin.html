<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Section Carpe Soufflenheim</title>
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #22c55e; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        /* Login */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: white; padding: 2rem; border-radius: 12px; text-align: center; width: 300px; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }

        /* Dashboard */
        .container { max-width: 1000px; margin: 0 auto; display: none; } /* Cach√© par d√©faut */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: #1e293b; }
        .btn-logout { background: #64748b; color: white; padding: 8px 16px; text-decoration: none; border-radius: 6px; }

        /* Cartes */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-top: 0; color: #334155; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: #475569; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
        .badge-admin { background: #e0f2fe; color: #0369a1; }
        .badge-client { background: #dcfce7; color: #15803d; }

        /* Formulaires */
        .date-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        .btn-save { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .btn-delete { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn-block { background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

        .session-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2>üîê Administration</h2>
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="checkLogin()">Entrer</button>
            <p id="errorMsg" style="color: red; display: none; margin-top: 10px;">Mot de passe incorrect</p>
        </div>
    </div>

    <!-- PANEL ADMIN -->
    <div class="container" id="adminPanel">
        <header>
            <h1>‚öôÔ∏è Gestion Carpe Soufflenheim</h1>
            <div>
                <a href="index.html" target="_blank" style="margin-right: 15px;">Voir le site</a>
                <a href="#" onclick="logout()" class="btn-logout">D√©connexion</a>
            </div>
        </header>

        <!-- GESTION DES SESSIONS -->
        <div class="card">
            <h2>üìÖ Dates des Sessions</h2>
            <div id="sessionsList">Chargement...</div>
        </div>

        <!-- BLOQUER UN POSTE -->
        <div class="card">
            <h2>üîí Bloquer un poste manuellement</h2>
            <div style="display: flex; gap: 10px;">
                <select id="sessionSelect" style="padding: 8px; border-radius: 4px;">
                    <!-- Rempli par JS -->
                </select>
                <select id="posteSelect" style="padding: 8px; border-radius: 4px;">
                    <option value="1">Poste 1</option>
                    <option value="2">Poste 2</option>
                    <option value="3">Poste 3</option>
                    <option value="4">Poste 4</option>
                    <option value="5">Poste 5</option>
                    <option value="6">Poste 6</option>
                    <option value="7">Poste 7</option>
                    <option value="8">Poste 8</option>
                    <option value="9">Poste 9</option>
                    <option value="10">Poste 10</option>
                </select>
                <button class="btn-block" onclick="bloquerPoste()">Bloquer ce poste</button>
            </div>
        </div>

        <!-- LISTE DES R√âSERVATIONS -->
        <div class="card">
            <h2>üìã Liste des R√©servations</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Session</th>
                        <th>Poste</th>
                        <th>Client</th>
                        <th>Contact</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="reservationsTable">
                    <!-- Rempli par JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è REMPLACE TES CLES ICI AUSSI
        const SUPABASE_URL = https://drhsdlzhxkbamwcskblr.supabase.co;
        const SUPABASE_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaHNkbHpoeGtiYW13Y3NrYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjg0NDMsImV4cCI6MjA4NTg0NDQ0M30.8nifIWVXkk0VXrlP4zeyMpEhIA-JrWh1Y6P94OdlH_g;
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Mot de passe admin (Simple)
        const ADMIN_PASS = "Souffcarpe1664"; 

        // --- AUTH ---
        function checkLogin() {
            const pass = document.getElementById('password').value;
            if (pass === ADMIN_PASS) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadData();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function logout() {
            location.reload();
        }

        // --- CHARGEMENT DES DONNEES ---
        let allSessions = [];

        async function loadData() {
            // 1. Charger Sessions
            const { data: sessions, error: errS } = await supabase
                .from('sessions')
                .select('*')
                .order('id');
            
            allSessions = sessions;
            renderSessions(sessions);
            renderBlockSelect(sessions);

            // 2. Charger R√©servations
            loadReservations();
        }

        async function loadReservations() {
            const { data: resas, error } = await supabase
                .from('reservations')
                .select('*, sessions(nom)')
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('reservationsTable');
            tbody.innerHTML = '';

            if(resas) {
                resas.forEach(r => {
                    const isManual = r.paypal_order_id === 'MANUAL';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${r.id}</td>
                        <td>${r.sessions?.nom || 'Inconnu'}</td>
                        <td><strong>Poste ${r.poste_numero}</strong></td>
                        <td>
                            ${r.nom_client} 
                            ${isManual ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge badge-client">PayPal</span>'}
                        </td>
                        <td>${r.email_client}<br><small>${r.telephone_client || ''}</small></td>
                        <td>
                            <button class="btn-delete" onclick="supprimerResa(${r.id})">Supprimer</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- FONCTIONS ADMIN ---

        // 1. Afficher et Modifier Sessions
        function renderSessions(sessions) {
            const container = document.getElementById('sessionsList');
            container.innerHTML = '';
            
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'session-row';
                div.innerHTML = `
                    <strong style="width: 150px;">${s.nom}</strong>
                    <input type="date" id="start-${s.id}" value="${s.date_debut}" class="date-input">
                    <span>au</span>
                    <input type="date" id="end-${s.id}" value="${s.date_fin}" class="date-input">
                    <button class="btn-save" onclick="updateDates(${s.id})">Enregistrer</button>
                `;
                container.appendChild(div);
            });
        }

        async function updateDates(id) {
            const start = document.getElementById(`start-${id}`).value;
            const end = document.getElementById(`end-${id}`).value;

            const { error } = await supabase
                .from('sessions')
                .update({ date_debut: start, date_fin: end })
                .eq('id', id);

            if (!error) alert('‚úÖ Dates mises √† jour !');
            else alert('‚ùå Erreur update');
        }

        // 2. Supprimer R√©servation
        async function supprimerResa(id) {
            if(confirm("√ätes-vous s√ªr de vouloir supprimer cette r√©servation ? Cela lib√©rera le poste.")) {
                const { error } = await supabase
                    .from('reservations')
                    .delete()
                    .eq('id', id);
                
                if(!error) {
                    loadReservations(); // Recharger le tableau
                } else {
                    alert("Erreur lors de la suppression");
                }
            }
        }

        // 3. Bloquer manuellement (liste d√©roulante)
        function renderBlockSelect(sessions) {
            const select = document.getElementById('sessionSelect');
            select.innerHTML = '';
            sessions.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.text = s.nom;
                select.appendChild(opt);
            });
        }

        async function bloquerPoste() {
            const sessionId = document.getElementById('sessionSelect').value;
            const posteId = document.getElementById('posteSelect').value;

            // V√©rifier si d√©j√† pris
            const { data: existing } = await supabase
                .from('reservations')
                .select('*')
                .eq('session_id', sessionId)
                .eq('poste_numero', posteId);

            if(existing && existing.length > 0) {
                alert("‚ùå Ce poste est d√©j√† r√©serv√© pour cette session !");
                return;
            }

            const { error } = await supabase.from('reservations').insert({
                session_id: sessionId,
                poste_numero: posteId,
                nom_client: "BLOQU√â ADMIN",
                email_client: "admin@local",
                telephone_client: "-",
                paypal_order_id: "MANUAL"
            });

            if(!error) {
                alert(`‚úÖ Poste ${posteId} bloqu√© avec succ√®s.`);
                loadReservations();
            } else {
                alert("Erreur lors du blocage");
            }
        }
    </script>
</body>
</html>

